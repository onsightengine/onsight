/**
 * @description Onsight Engine
 * @about       Powerful, easy-to-use JavaScript video game and application creation engine.
 * @author      Stephens Nunnally <@stevinz>
 * @version     v0.0.3
 * @license     MIT - Copyright (c) 2021-2022 Stephens Nunnally and Scidian Software
 * @source      https://github.com/onsightengine/onsight
 */
import*as e from"three";import{mergeBufferGeometries as t}from"three/addons/utils/BufferGeometryUtils.js";import{SVGLoader as i}from"three/addons/loaders/SVGLoader.js";import{Line2 as s}from"three/addons/lines/Line2.js";import{LineGeometry as r}from"three/addons/lines/LineGeometry.js";import{LineMaterial as n}from"three/addons/lines/LineMaterial.js";import{LineSegmentsGeometry as a}from"three/addons/lines/LineSegmentsGeometry.js";import{Wireframe as o}from"three/addons/lines/Wireframe.js";import{WireframeGeometry2 as l}from"three/addons/lines/WireframeGeometry2.js";import{Pass as c}from"three/addons/postprocessing/Pass.js";import{RoundedBoxGeometry as h}from"three/addons/geometries/RoundedBoxGeometry.js";import{LoopSubdivision as d}from"three-subdivide";const u="0.0.3",p={RENDERER_3D:{ONSIGHT:"ONE",THREE:"THREE"},PHYSICS_3D:{CANNON:"CANNON",RAPIER:"RAPIER"}},m={Entity3D:"Entity3D"},y={Scene3D:"Scene3D"},f={World3D:"World3D"},g={LOCKED:"flagLocked",TEMP:"flagTemp"},b={PLAYING:"playing",PAUSED:"paused",STOPPED:"stopped"},w=.01,x=5,v=0,S=new e.Raycaster;class k{static createOrthographic(t,i,s="none",r=0){const n=new e.OrthographicCamera(0,1,1,0,-1e3,1e3);return n.desiredSize=r,n.fitType=s,n.position.set(0,0,5),n.lookAt(0,0,0),k.updateOrthographic(n,t,i),n}static createPerspective(t,i,s=!0){const r=new e.PerspectiveCamera(58.1,1,.01,1e3);return r.tanFOV=Math.tan(Math.PI/180*r.fov/2),r.windowHeight=s?1e3:0,r.fixedSize=s,r.position.set(0,0,5),r.lookAt(0,0,0),k.updatePerspective(r,t,i),r}static updateCamera(e,t,i){e.isPerspectiveCamera&&k.updatePerspective(e,t,i),e.isOrthographicCamera&&k.updateOrthographic(e,t,i)}static updatePerspective(e,t,i){e.fixedSize&&(e.fov=360/Math.PI*Math.atan(e.tanFOV*(i/e.windowHeight))),e.aspect=t/i,e.updateProjectionMatrix()}static updateOrthographic(e,t,i){let s=e.fitType,r=0;e.desiredSize?r=e.desiredSize:s="none";let n=1,a=1,o=r,l=r;"none"===s?(o=.01*t*.5,l=.01*i*.5):"width"===s?a=i/t:"height"===s&&(n=t/i),e.left=-o/n/2,e.right=o/n/2,e.top=l*a/2,e.bottom=-l*a/2,e.updateProjectionMatrix()}static screenPoint(t,i){return i&&i.isCamera?new e.Vector3.copy(t).project(i):(console.warn("CameraUtils.screenPoint: No camera provided!"),new e.Vector3)}static worldPoint(t,i,s=new e.Vector3,r="xy"){if(!i||!i.isCamera)return console.warn("CameraUtils.worldPoint: No camera provided!"),new e.Vector3;const n=new e.PlaneGeometry(1e8,1e8,2,2);switch(r.toLowerCase()){case"yz":n.rotateY(Math.PI/2);break;case"xz":n.rotateX(Math.PI/2)}n.translate(s.x,s.y,s.z);const a=new e.MeshBasicMaterial({side:e.DoubleSide}),o=new e.Mesh(n,a);S.setFromCamera(t,i),i.isOrthographicCamera&&S.ray.origin.set(t.x,t.y,-i.far).unproject(i);const l=S.intersectObject(o,!0);return n.dispose(),a.dispose(),l.length>0&&l[0].point}static distanceToFitObject(e,t,i=1.25){}static fitCameraToObject(t,i,s=null,r=1.25){const n=new e.Box3;n.setFromObject(i);const a=n.getCenter(new e.Vector3),o=n.getSize(new e.Vector3),l=o.z/(2*Math.atan(Math.PI*t.fov/360)),c=Math.max(l,o.y/(2*Math.atan(Math.PI*t.fov/360))),h=o.x/(2.5*Math.atan(Math.PI*t.fov/360))/t.aspect,d=r*Math.max(c,h);t.near=d/100,t.far=100*d,t.updateProjectionMatrix(),t.position.copy(a),t.position.z+=d,t.lookAt(a),s&&(s.maxDistance=10*d,s.target.copy(a),s.update())}}class M{static radiansToDegrees(e){return e*(180/Math.PI)}static degreesToRadians(e){return Math.PI/180*e}static fuzzyFloat(e,t,i=.001){return e<t+i&&e>t-i}static fuzzyVector(e,t,i=.001){return!1!==M.fuzzyFloat(e.x,t.x,i)&&(!1!==M.fuzzyFloat(e.y,t.y,i)&&!1!==M.fuzzyFloat(e.z,t.z,i))}static fuzzyQuaternion(e,t,i=.001){return!1!==M.fuzzyVector(e,t,i)&&!1!==M.fuzzyFloat(e.w,t.w,i)}static clamp(e,t,i){return(e=Number(e))<t&&(e=t),e>i&&(e=i),e}static damp(e,t,i,s){return M.lerp(e,t,1-Math.exp(-i*s))}static lerp(e,t,i){return(1-i)*e+i*t}static roundTo(e,t=0){const i=Math.pow(10,t);return Math.round(e*i)/i}static isPowerOfTwo(e){return 0==(e&e-1)&&0!==e}static addCommas(e){return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}static countDecimals(e){return Math.floor(e.valueOf())===e.valueOf()?0:e.toString().split(".")[1].length||0}static isNumber(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}static lineCollision(e,t,i,s,r,n,a,o){let l=(o-n)*(i-e)-(a-r)*(s-t);if(M.fuzzyFloat(l,0,1e-7))return!1;let c=((a-r)*(t-n)-(o-n)*(e-r))/l,h=((i-e)*(t-n)-(s-t)*(e-r))/l;return c>=0&&c<=1&&h>=0&&h<=1}static lineRectCollision(e,t,i,s,r,n,a,o){const l=M.lineCollision(e,t,i,s,r,n,r,o),c=M.lineCollision(e,t,i,s,a,n,a,o),h=M.lineCollision(e,t,i,s,r,n,a,n),d=M.lineCollision(e,t,i,s,r,o,a,o);return l||c||h||d}static randomFloat(e,t){return e+Math.random()*(t-e)}static randomInt(e=0,t=1){return e+Math.floor(Math.random()*(t-e))}}class z{static arrayFromArguments(){return 1===arguments.length&&Array.isArray(arguments[0])?arguments[0]:Array.from(arguments)}static isIterable(e){return null!=e&&"function"==typeof e[Symbol.iterator]}static isObject(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}static save(e,t){try{const i=document.createElement("a");document.body.appendChild(i),i.href=e,i.download=t||"data.json",i.click(),setTimeout((function(){document.body.removeChild(i),window.URL.revokeObjectURL(e)}),0)}catch(e){return void console.warn(e)}}static saveBuffer(e,t,i={type:"application/octet-stream"}){let s=URL.createObjectURL(new Blob([e],{type:i}));z.save(s,t)}static saveImage(e,t){z.save(e,t)}static saveString(e,t){let i=URL.createObjectURL(new Blob([e],{type:"text/plain"}));z.save(i,t)}static detectOS(){let e={Android:["android"],iOS:["iphone","ipad","ipod","ios"],Linux:["linux","x11","wayland"],Mac:["mac","darwin","osx","os x"],Win:["win"]},t=window.navigator.userAgent,i=window.navigator.userAgentData,s=i?i.platform:t;s=s.toLowerCase();for(let t in e)for(let i of e[t])if(-1!==s.indexOf(i))return t;return"Unknown OS"}static fullscreen(e){if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement){let e=document;(e.cancelFullScreen||e.exitFullscreen||e.webkitCancelFullScreen||e.webkitExitFullscreen||e.mozCancelFullScreen).call(e)}else{let t=e??document.body;(t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullScreen).call(t)}}static metaKeyOS(){return"Mac"===z.detectOS()?"⌘":"⌃"}static sleep(e){const t=Date.now();let i=t;for(;i-t<e;)i=Date.now()}static waitForObject(e,t,i,s=1e3,r=!1,n=5e3){let a=Date.now(),o=Date.now();!function l(){n&&Date.now()-o>n&&(console.info(`Still waiting on operation: ${e}`),o=Date.now()),void 0===t()||null===t()?setTimeout((function(){r&&Date.now()-a>r||l()}),s):i()}()}}const C=new e.Box3,A=new e.Matrix4,B=new e.Vector3,P=new e.Quaternion,E=new e.Quaternion,O=new e.Quaternion,T=new e.Vector3,j=new e.Quaternion,F=(new e.Euler,new e.Vector3);class D{static allowSelection(e){let t=!0;return e.userData&&(e.userData.flagLocked&&(t=!1),e.userData.flagTemp&&(t=!1)),t}static checkTransforms(e){if(e.length<=1)return!0;e[0].getWorldQuaternion(P);for(let t=1;t<e.length;t++)if(e[t].getWorldQuaternion(O),!1===M.fuzzyQuaternion(P,O))return!1;return!0}static clearObject(e,t=!0){if(e){for(;e.children.length>0;)D.clearObject(e.children[0],!0);e.geometry&&e.geometry.dispose(),e.material&&D.clearMaterial(e.material),D.resetTransform(e),t&&e.removeFromParent()}}static clearMaterial(e){!0!==z.isIterable(e)&&(e=[e]);for(let t=0,i=e.length;t<i;t++){let i=e[t];Object.keys(i).forEach((e=>{i[e]&&"function"==typeof i[e].dispose&&i[e].dispose()})),i.dispose()}}static computeBounds(t,i,s=!1){void 0!==i&&!0===i.isBox3||(i=new e.Box3);const r=z.isIterable(t)?t:[t];if(i.makeEmpty(),s&&1===D.countGeometry(t)){let e;if(r.forEach((t=>{t.traverse((t=>{t.geometry&&(e=t)}))})),e&&e.geometry)return e.geometry.computeBoundingBox(),i.copy(e.geometry.boundingBox),e.matrixWorld.decompose(T,j,F),j.identity(),A.compose(T,j,F),i.applyMatrix4(A),i}return r.forEach((e=>i.expandByObject(e))),i}static computeCenter(e,t){const i=z.isIterable(e)?e:[e];if(D.computeBounds(i,C),C.isEmpty())for(let e of i)e.getWorldPosition(B),C.expandByPoint(B);return C.getCenter(t),t}static containsObject(e,t){if(t&&t.uuid&&z.isIterable(e))for(let i=0;i<e.length;i++)if(e[i].uuid===t.uuid)return!0;return!1}static copyLocalTransform(e,t,i=!0){e.updateMatrix(),e.matrix.decompose(t.position,E,t.scale),t.rotation.setFromQuaternion(E,void 0,!1),i&&t.updateMatrix()}static copyWorldTransform(e,t,i=!0){e.updateWorldMatrix(!0,!0),e.matrixWorld.decompose(t.position,E,t.scale),t.rotation.setFromQuaternion(E,void 0,!1),i&&t.updateMatrix()}static countGeometry(e){const t=z.isIterable(e)?e:[e];let i=0;return t.forEach((e=>{e.traverse((e=>{e.geometry&&i++}))})),i}static flattenGroup(e){if(e&&e.parent){for(;e.children;)e.parent.attach(e.children[0]);D.clearObject(e,!0)}}static resetTransform(e){e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}static tempObjectRemoval(e){const t=[];e.traverse((e=>{e.userData&&e.userData.flagTemp&&t.push({object:e,parent:e.parent})}));for(let e=0;e<t.length;e++)t[e].object.removeFromParent();return t}static tempObjectRestore(e){for(let t=0;t<e.length;t++){let i=e[t];i.parent.attach(i.object)}}}class R{static addSpaces(e){return String(e).replace(/([A-Z])/g," $1").trim()}static capitalize(e){const t=String(e).split(" ");for(let e=0;e<t.length;e++)t[e]=t[e][0].toUpperCase()+t[e].substring(1);return t.join(" ")}static countDigits(e){return parseFloat(e).toString().length}static nameFromUrl(e,t=!0){let i=new String(e.replace(/^.*[\\\/]/,""));return i=i.replace(/\.[^/.]+$/,""),t&&(i=R.capitalize(i)),i}}const V={},I={},L=new e.TextureLoader;class G{static assetType(e){return e.isBufferGeometry?"geometry":e.isMaterial?"material":e.isTexture?"texture":"asset"}static getLibrary(e){const t=[];for(const[i,s]of Object.entries(V))G.assetType(s)===e&&t.push(s);return t}static addAsset(e){if(!e)return;const i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;e++){let s=i[e];if(s.isBufferGeometry&&(s.name&&""!==s.name||(s.name=s.constructor.name),"BufferGeometry"!==s.constructor.name)){const e=t([s]);e.name=s.name,e.uuid=s.uuid,s.dispose(),s=e}V[s.uuid]=s}return e}static getAsset(e){return e&&e.uuid&&(e=e.uuid),V[e]}static removeAsset(e,t=!0){if(!e)return;const i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;e++){const s=i[e];if(V[s.uuid]){if(s.isTexture)for(let e in I)I[e].uuid===s.uuid&&delete I[e];t&&"function"===s.dispose&&s.dispose(),delete V[s.uuid]}}}static loadTexture(t,i){if(!t||""===t)return null;const s=e.DefaultLoadingManager.resolveURL(t);if(I[s])return console.log("AssetManager.loadTexture: Duplicate image!"),I[s];const r=L.load(t,(function(t){t.name=R.nameFromUrl(t.image.src),t.premultiplyAlpha=!0,t.wrapS=e.RepeatWrapping,t.wrapT=e.RepeatWrapping,i&&"function"==typeof i&&i(t)}),(function(){I[s]&&I[s].isTexture&&I[s].dispose();delete I[s]}));return I[s]=r,r}static clear(){for(let e in V)G.removeAsset(V[e],!0)}static fromJSON(t){function i(e){for(const[t,i]of Object.entries(e))G.addAsset(i)}G.clear();const s=new e.ObjectLoader,r=s.parseAnimations(t.animations),n=s.parseShapes(t.shapes),a=s.parseGeometries(t.geometries,n),o=s.parseImages(t.images),l=s.parseTextures(t.textures,o),c=s.parseMaterials(t.materials,l);i(r),i(n),i(a),i(o),i(l),i(c)}static toJSON(e){const t={};e||(e={}),e.shapes||(e.shapes={}),e.geometries||(e.geometries={}),e.images||(e.images={}),e.textures||(e.textures={}),e.materials||(e.materials={}),e.animations||(e.animations={}),e.skeletons||(e.skeletons={});const i={images:{},textures:{},materials:{}},s=G.getLibrary("geometry");for(let t=0;t<s.length;t++){const i=s[t];if(e.geometries[i.uuid]||(e.geometries[i.uuid]=i.toJSON(e)),i.parameters&&i.parameters.shapes){const t=i.parameters.shapes;!0!==Array.isArray(t)&&(t=[t]);for(let i=0,s=t.length;i<s;i++){const s=t[i];e.shapes[s.uuid]||(e.shapes[s.uuid]=s.toJSON(e))}}}const r=G.getLibrary("material");for(let t=0;t<r.length;t++){const s=r[t];e.materials[s.uuid]||(e.materials[s.uuid]=s.toJSON(i))}const n=G.getLibrary("texture");for(let t=0;t<n.length;t++){const i=n[t];e.textures[i.uuid]||(e.textures[i.uuid]=i.toJSON(e))}for(const i in e){const s=[];for(const t in e[i]){const r=e[i][t];delete r.metadata,s.push(r)}s.length>0&&(t[i]=s)}return t}}const N={};class _{static registered(e=""){const t=N[e];return t||console.warn(`ComponentManager.registered: Component '${e}' not registered'`),t}static registeredTypes(){return Object.keys(N)}static register(e="",t){if(e=e.toLowerCase(),N[e])return console.warn(`ComponentManager.register: Component '${e}' already registered`);z.isObject(t.config)||(t.config={}),z.isObject(t.config.schema)||(t.config.schema={});const i=t.config.schema;for(const e in i){const t=Array.isArray(i[e])?i[e]:[i[e]];for(let e=0,i=t.length;e<i;e++){const i=t[e];if(void 0===i.type)console.warn("ComponentManager.register(): All schema properties require a 'type' value");else if("divider"===i.type)continue;if(void 0===i.default)switch(i.type){case"select":case"asset":case"map":case"shape":i.default=null;break;case"number":case"int":case"angle":case"slider":case"scroller":i.default=0;break;case"boolean":i.default=!1;break;case"color":i.default=16777215;break;case"variable":case"vector2":i.default=[0,0];break;case"array":i.default=[];break;case"vector3":i.default=[0,0,0];break;case"vector4":i.default=[0,0,0,0];break;case"string":case"script":i.default="";break;default:console.warn(`ComponentManager.register(): Unknown property type: '${i.type}'`),i.default=null}void 0!==i.proMode&&(i.promode=i.proMode)}}N[e]=class extends t{constructor(){super(),this.isComponent=!0,this.enabled=!0,this.tag="",this.type=e,this.entity=null,this.data={}}init(e){super.init(e)}dispose(){super.dispose()}disable(){this.enabled=!1,super.disable()}enable(){this.enabled=!0,super.enable()}defaultData(){const e={};for(let t=0,i=arguments.length;t<i;t+=2)e[arguments[t]]=arguments[t+1];return _.sanitizeData(this.type,e),e.base={enabled:this.enabled,tag:this.tag,type:this.type},e}}}static includeData(e,t,i){for(let s in e.if){let r=e.if[s];!0!==z.isIterable(r)&&(r=[r]);let n=!1,a=!1;for(let e=0;e<r.length;e++)n=n||t[s]===r[e],a=!(!a&&void 0!==i)||i[s]===r[e];if(!n||!a)return!1}for(let s in e.not){let r=e.not[s];!0!==z.isIterable(r)&&(r=[r]);let n=!1,a=!1;for(let e=0;e<r.length;e++)n=n||t[s]===r[e],a=!a&&void 0!==i&&i[s]===r[e];if(n||a)return!1}return!0}static sanitizeData(e,t){const i=_.registered(e),s=i&&i.config?i.config.schema:{};for(let e in s){let i,r=s[e];!0!==z.isIterable(r)&&(r=[s[e]]);for(let e=0;e<r.length;e++){let s=r[e];if("divider"!==s.type&&_.includeData(s,t)){i=s;break}}if(void 0!==i){if(void 0===t[e]&&(t[e]=i.default),M.isNumber(t[e])){const s=i.min??-1/0,r=i.max??1/0;t[e]<s&&(t[e]=s),t[e]>r&&(t[e]=r)}}else delete t[e]}}static stripData(e,t,i){const s=_.registered(e),r=s&&s.config?s.config.schema:{};for(let e in r){let s=!1,n=r[e];!0!==z.isIterable(n)&&(n=[r[e]]);for(let e=0;e<n.length;e++){let r=n[e];if("divider"!==r.type&&_.includeData(r,t,i)){s=!0;break}}!0!==s&&delete i[e]}}}new e.Matrix4;const W=new e.Vector3,U=new e.Quaternion,H=new e.Vector3,q=(new e.Quaternion,new e.Vector3,new e.Vector3),J=new e.Vector3,$=(new e.Quaternion,new e.Quaternion),Y=new e.Quaternion,Q=(new e.Euler,new e.Quaternion),X=new e.Vector3,K=new e.Quaternion,Z=new e.Vector3,ee=new e.Euler;class te extends e.Object3D{constructor(){super();const t=new e.Euler,i=new e.Quaternion;t._onChange((function(){})),i._onChange((function(){})),Object.defineProperties(this,{rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i}})}copy(e,t=!0){return super.copy(e,t),D.copyLocalTransform(e,this,!1),this.lookAtCamera=e.lookAtCamera,this.updateMatrix(),this}getWorldQuaternion(e,t=!0){let i=this.lookAtCamera;return t&&i&&(this.lookAtCamera=!1),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(q,e,J),t&&i&&(this.lookAtCamera=!0,this.updateWorldMatrix(!0,!1)),e}safeAttach(e){e&&e.isObject3D&&(e.getWorldQuaternion(K),e.getWorldScale(Z),e.getWorldPosition(X),e.removeFromParent(),e.rotation.copy(ee.setFromQuaternion(K,void 0,!1)),e.scale.copy(Z),e.position.copy(X),this.attach(e))}updateMatrix(){const e=window.activeCamera;let t=this.lookAtCamera&&e&&!this.isScene;t&&this.parent&&this.parent.isObject3D&&this.traverseAncestors((e=>{e.lookAtCamera&&(t=!1)})),t?(e.matrixWorld.decompose(W,U,H),this.matrixWorld.decompose(X,K,Z),Q.setFromEuler(this.rotation,!1),this.quaternion.copy(U),this.quaternion.multiply(Q),this.parent&&this.parent.isObject3D&&(this.parent.getWorldQuaternion($,!1),Y.copy($).invert(),this.quaternion.multiply(Y))):this.quaternion.setFromEuler(this.rotation,!1),this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}}class ie extends te{constructor(e=""){super(),this.isEntity=!0,this.isEntity3D=!0,this.name=e,this.type="Entity3D",this.project=null,this.enabled=!0,this.castShadow=!0,this.receiveShadow=!0,this.lookAtCamera=!1,this.components=[],this.setFlag(g.LOCKED,!1)}getReducedType(){return this.isScene?"Scene":1===this.components.length?R.capitalize(this.components[0].type.toLowerCase()):"Entity3D"}getFlag(e){return Boolean(this.userData[e])}setFlag(e,t){return this.userData[e]=t,this}addComponent(e,t={},i=!0){const s=_.registered(e);if(void 0===s)return;const r=s.config;let n=this.getComponent(e);if(s.config.multiple||void 0===n?(n=new s,this.components.push(n)):n.disable(),r.dependencies&&i){const e=r.dependencies;for(let t=0,i=e.length;t<i;t++)void 0===this.getComponent(e[t])&&this.addComponent(e[t],{},!1)}return n.entity=this,_.sanitizeData(e,t),n.init&&n.init(t),this.enabled&&n.enable(),n}getComponent(e,t){if(void 0===t)return this.getComponentByProperty("type",e);let i=this.getComponentsWithProperties("type",e,"tag",t);return i.length>0?i[0]:void 0}getComponentByTag(e){return this.getComponentByProperty("tag",e)}getComponentByType(e){return this.getComponentByProperty("type",e)}getComponentByProperty(e,t){for(let i=0,s=this.components.length;i<s;i++){const s=this.components[i];if(s[e]===t)return s}}getComponentsWithProperties(){let e=[];for(let t=0,i=this.components.length;t<i;t++){const i=this.components[t];let s=!0;for(let e=0,t=arguments.length;e<t;e+=2)if(i[arguments[e]]!==arguments[e+1]){s=!1;break}s&&e.push(i)}return e}removeComponent(e){let t=this.components.indexOf(e);return-1!==t?(this.components.splice(t,1),e.disable(),e.dispose()):console.warn(`Entity3D.removeComponent: Component ${e.uuid}, type '${e.type}' not found`),e}rebuildComponents(){for(let e=0;e<this.components.length;e++){const t=this.components[e];t.disable(),t.init(t.toJSON()),t.enable()}}getEntities(){const e=[],t=this.children;for(let i=0;i<t.length;i++)t[i].isEntity3D&&e.push(t[i]);return e}getEntityById(e){return this.getEntityByProperty("id",e)}getEntityByName(e){return this.getEntityByProperty("name",e)}getEntityByUuid(e){return this.getEntityByProperty("uuid",e)}getEntityByProperty(e,t){if(this[e]===t)return this;const i=this.getEntities();for(let s=0,r=i.length;s<r;s++){const r=i[s].getEntityByProperty(e,t);if(r)return r}}traverseEntities(e){this.traverse((t=>{t.isEntity3D&&e(t)}))}cloneEntity(e=!0){return(new this.constructor).copyEntity(this,e)}copyEntity(e,t=!0){this.destroy(),super.copy(e,!1),this.name=e.name,this.enabled=e.enabled,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.lookAtCamera=e.lookAtCamera;for(let t in g)this.setFlag(g[t],e.getFlag(g[t]));const i=e.components;for(let e=0;e<i.length;e++){const t=i[e];let s=this.addComponent(t.type,t.toJSON(),!1);s.tag=t.tag,!0!==t.enabled&&s.disable()}if(!0===t){const t=e.getEntities();for(let e=0;e<t.length;e++){const i=t[e];this.add(i.cloneEntity(!0))}}return this}destroy(){let e=this.getEntities();for(let t=0;t<e.length;t++)this.project&&this.project.removeEntity(e[t]),e[t].destroy();for(;this.components.length>0;){let e=this.components[0];this.removeComponent(e)}}fromJSON(e){const t=e.object;this.uuid=t.uuid,void 0!==t.name&&(this.name=t.name),void 0!==t.enabled&&(this.enabled=t.enabled),void 0!==t.castShadow&&(this.castShadow=t.castShadow),void 0!==t.receiveShadow&&(this.receiveShadow=t.receiveShadow),void 0!==t.lookAtCamera&&(this.lookAtCamera=t.lookAtCamera),void 0!==t.position&&this.position.fromArray(t.position),void 0!==t.rotation&&this.rotation.fromArray(t.rotation),void 0!==t.scale&&this.scale.fromArray(t.scale),void 0!==t.matrixAutoUpdate&&(this.matrixAutoUpdate=t.matrixAutoUpdate),void 0!==t.layers&&(this.layers.mask=t.layers),void 0!==t.visible&&(this.visible=t.visible),void 0!==t.frustumCulled&&(this.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(this.renderOrder=t.renderOrder),void 0!==t.userData&&(this.userData=t.userData);for(let t in e.object.flags)this.setFlag(t,e.object.flags[t]);for(let t=0;t<e.object.components.length;t++){const i=e.object.components[t];if(i&&i.base&&i.base.type){const e=this.addComponent(i.base.type,i,!1);!1===i.enabled&&e.disable(),e.tag=i.base.tag}}if(void 0!==t.entities)for(let t=0;t<e.object.entities.length;t++){const i=(new ie).fromJSON(e.object.entities[t]);this.add(i)}return this.updateMatrix(),this}toJSON(){const e={object:{name:this.name,type:this.type,uuid:this.uuid,components:[],flags:{}}};for(let t in g)e.object.flags[t]=this.getFlag(t);for(let t=0;t<this.components.length;t++)e.object.components.push(this.components[t].toJSON());e.object.enabled=this.enabled,e.object.castShadow=this.castShadow,e.object.receiveShadow=this.receiveShadow,e.object.lookAtCamera=this.lookAtCamera,e.object.position=this.position.toArray(),e.object.rotation=this.rotation.toArray(),e.object.scale=this.scale.toArray(),e.object.matrixAutoUpdate=this.matrixAutoUpdate,e.object.layers=this.layers.mask,!1===this.visible&&(e.object.visible=!1),!1===this.frustumCulled&&(e.object.frustumCulled=!1),0!==this.renderOrder&&(e.object.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(e.object.userData=this.userData);const t=this.getEntities();if(t.length>0){e.object.entities=[];for(let i=0;i<t.length;i++)e.object.entities.push(t[i].toJSON())}return e}}class se extends ie{constructor(t="Start Scene"){super(),this.isScene=!0,this.isScene3D=!0,this.name=t,this.type="Scene3D",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,this.shadowPlane=new e.Mesh(new e.PlaneGeometry(1e5,1e5),new e.ShadowMaterial({color:0,transparent:!0,opacity:.2,depthWrite:!1})),this.shadowPlane.name="ShadowPlane",this.shadowPlane.userData.flagTemp=!0,this.shadowPlane.rotation.x=-Math.PI/2,this.shadowPlane.castShadow=!1,this.shadowPlane.receiveShadow=!0,this.shadowPlane.visible=!1,this.add(this.shadowPlane)}fromJSON(t){const i=t.object;if(void 0!==i.background)if(Number.isInteger(i.background))this.background=new e.Color(i.background);else{const e=G.getAsset(i.background);e&&e.isTexture&&(this.background=e)}if(void 0!==i.environment){const e=G.getAsset(i.background);e&&e.isTexture&&(this.environment=e)}return void 0!==i.fog&&("Fog"===i.fog.type?this.fog=new e.Fog(i.fog.color,i.fog.near,i.fog.far):"FogExp2"===i.fog.type&&(this.fog=new e.FogExp2(i.fog.color,i.fog.density))),super.fromJSON(t),this}toJSON(){const e=super.toJSON();return this.fog&&(e.object.fog=this.fog.toJSON()),e}}class re{constructor(e="World 1"){this.isWorld=!0,this.isWorld3D=!0,this.name=e,this.type="World3D",this.uuid=crypto.randomUUID(),this.order=0,this.startScene=null,this.lastEditorScene=null,this.sceneNodes={}}addScene(e){return e&&"Scene3D"===e.type?this.sceneNodes[e.uuid]?console.warn(`World3D.addScene: Scene ('${e.name}') already added`,e):(this.sceneNodes[e.uuid]={uuid:e.uuid,order:this.order++},this.startScene||(this.startScene=e.uuid),this.lastEditorScene||(this.lastEditorScene=e.uuid)):console.error("'World3D.addScene: Scene not of type 'Scene3D'",e),this}fromJSON(e){const t=e.object;return this.name=t.name,this.uuid=t.uuid,this.order=t.order,this.startScene=t.startScene,this.lastEditorScene=t.lastEditorScene,this.sceneNodes=t.sceneNodes,this}toJSON(){return{object:{name:this.name,type:this.type,uuid:this.uuid,order:this.order,startScene:this.startScene,lastEditorScene:this.lastEditorScene,sceneNodes:this.sceneNodes}}}}class ne{static combineEntityArrays(e,t){for(let i=0;i<t.length;i++){let s=t[i];!1===ne.containsEntity(e,s)&&e.push(s)}}static commonEntity(e,t){for(let i=0;i<e.length;i++)if(!0===ne.containsEntity(t,e[i]))return!0;for(let i=0;i<t.length;i++)if(!0===ne.containsEntity(e,t[i]))return!0;return!1}static compareArrayOfEntities(e,t){for(let i=0;i<e.length;i++)if(!1===ne.containsEntity(t,e[i]))return!1;for(let i=0;i<t.length;i++)if(!1===ne.containsEntity(e,t[i]))return!1;return!0}static containsEntity(e,t){if(t&&t.uuid&&Array.isArray(e))for(let i=0;i<e.length;i++)if(e[i].uuid===t.uuid)return!0;return!1}static isImportant(e){let t=!1;return t=t||null===e.parent,t=t||e.isScene,t=t||e.userData.flagLocked,t}static parentEntity(e,t=!1){for(;e&&e.parent&&!0!==e.parent.isScene;)if(e=e.parent,t&&e.isEntity)return e;return e}static parentScene(e){for(;e&&e.parent;)if((e=e.parent).isScene)return e}static removeEntityFromArray(e,t){let i=e.length;for(let s=0;s<i;s++)e[s].uuid===t.uuid&&(e.splice(s,1),i=e.length)}static uuidArray(e){let t=[];for(let i=0;i<e.length;i++)t.push(e[i].uuid);return t}}class ae{constructor(e="My Project"){this.isProject=!0,this.name=e,this.uuid=crypto.randomUUID(),this.type="Project",this.scripts={},this.scenes={},this.worlds={}}addWorld(e){return e&&f[e.type]?(this.worlds[e.uuid]=e,null==this.activeWorldUuid&&(this.activeWorldUuid=e.uuid)):console.error(`Project.addWorld: World type (${e.type}) not a valid world type`,e),this}getWorldByName(e){return this.getWorldByProperty("name",e)}getWorldByUuid(e){return this.worlds[e]}getWorldByProperty(e,t){for(const i in this.worlds){const s=this.worlds[i];if(s[e]===t)return s}}addScene(e){return e&&y[e.type]?this.scenes[e.uuid]?console.warn(`Project.addScene: Scene ('${e.name}') already added`,e):this.scenes[e.uuid]=e:console.error(`Project.addScene: Scene type (${e.type}) not a valid scene type`,e),this}getFirstScene(){const e=Object.keys(this.scenes);return e.length>0?this.scenes[e[0]]:null}getSceneByName(e){return this.getSceneByProperty("name",e)}getSceneByUuid(e){return this.scenes[e]}getSceneByProperty(e,t){for(const i in this.scenes){const s=this.scenes[i];if(s[e]===t)return s}}removeScene(e){if(!0!==e.isScene)return;const t=e.getEntities();for(let e=t.length-1;e>=0;e--)this.removeEntity(t[e],!0),t[e].destroy();delete this.scenes[e.uuid]}traverseScenes(e){for(let t in this.scenes){this.scenes[t].traverseEntities(e)}}addEntity(e,t,i=-1,s=!1){if(e){if(null==i&&(i=-1),e.isObject3D)if(t&&t.children&&-1!==i)t.children.splice(i,0,e),e.parent=t;else{let i=t;i&&i.isObject3D||window.editor&&(i=window.editor.viewport.scene),i&&i.isObject3D&&(s?i.attach(e):i.add(e))}return this}}getEntityByUuid(e,t=!1){let i=[],s=null;if(window.editor&&(s=window.editor.viewport.scene),t){i=Array.from(this.scenes);const e=i.indexOf(s),t=0;s&&-1!==e&&(arr.splice(e,1),arr.splice(t,0,s))}else s&&i.push(s);for(let t=0;t<i.length;t++){const s=i[t].getEntityByProperty("uuid",e);if(s)return s}}moveEntity(e,t,i,s=-1){e&&(t&&t.isObject3D||!window.editor||(t=window.editor.viewport.scene),t&&t.isObject3D&&(t.safeAttach(e),i&&(s=t.children.indexOf(i)),-1!==s&&(t.children.splice(s,0,e),t.children.pop())))}removeEntity(e,t=!1){e&&(!t&&ne.isImportant(e)||e.parent&&e.parent.remove(e))}addScript(e,t){const i=e.uuid;return this.scripts[i]||(this.scripts[i]=[]),this.scripts[i].push(t),this}removeScript(e,t){const i=e.uuid;if(!this.scripts[i])return;const s=this.scripts[i].indexOf(t);-1!==s&&this.scripts[i].splice(s,1)}clear(){const e=Object.keys(this.scenes);for(let t=0;t<e.length;t++){let i=this.scenes[e[t]];this.removeScene(i)}this.name="My Project",this.uuid=crypto.randomUUID()}fromJSON(e,t=!0){const i=e.metadata?e.metadata.type:"Undefined";if("Onsight"!==i)return void console.error(`Project.fromJSON: Unknown project type ('${i}'), expected 'Onsight'`);const s=e.metadata.version;if("0.0.3"!==s&&console.warn(`Project.fromJSON: Project saved in 'v${s}', attempting to load with 'v0.0.3'`),e.object&&e.object.type===this.type){this.clear(),t&&G.fromJSON(e),this.name=e.object.name,this.uuid=e.object.uuid,this.scripts=e.scripts;for(let t=0;t<e.worlds.length;t++)if("World3D"===e.worlds[t].object.type)this.addWorld((new re).fromJSON(e.worlds[t]));for(let t=0;t<e.scenes.length;t++)if("Scene3D"===e.scenes[t].object.type)this.addScene((new se).fromJSON(e.scenes[t]));return this}console.error("Project.fromJSON: Save file corrupt, no 'Project' object found!")}toJSON(){const e=G.toJSON({});e.metadata={type:"Onsight",version:"0.0.3",generator:"Onsight.Project.toJSON"},e.object={name:this.name,type:this.type,uuid:this.uuid},e.scripts=this.scripts,e.scenes=[],e.worlds=[];for(const t in this.worlds){const i=this.worlds[t];e.worlds.push(i.toJSON())}for(const t in this.scenes){const i=this.scenes[t];e.scenes.push(i.toJSON())}return e}}class oe{constructor(){const t=this;this.backend={},this.backend.renderer=p.RENDERER_3D.THREE,this.backend.physics=p.PHYSICS_3D.RAPIER;let i,s,r,n=this,a=new ae,o=b.STOPPED;Object.defineProperty(t,"scene",{get:function(){return r},set:function(e){r=e}}),this.width=1,this.height=1,this.wantsScreenshot=!1,i=new e.WebGLRenderer({antialias:!0}),i.setPixelRatio(1),i.shadowMap.enabled=!0,this.dom=document.createElement("div"),this.dom.appendChild(i.domElement);let l="player,renderer,scene,camera",c={init:[],update:[],keydown:[],keyup:[],pointerdown:[],pointerup:[],pointermove:[]};function h(e,t){for(let i=0,s=e.length;i<s;i++)e[i](t)}this.load=function(e,t=!0){a.fromJSON(e,t),this.scene=a.getFirstScene(),this.setCamera(k.createPerspective(500,500,!0)),s.position.x=0,s.position.y=0,document.addEventListener("keydown",x),document.addEventListener("keyup",v),document.addEventListener("pointerdown",S),document.addEventListener("pointerup",M),document.addEventListener("pointermove",C);let o="",d={};for(let e in c)o+=e+",",d[e]=e;o=o.replace(/.$/,"");let u=JSON.stringify(d).replace(/\"/g,"");function p(e){const t=a.scripts[e.uuid];if(void 0!==t&&t.length>0)for(let a=0,h=t.length;a<h;a++){let h=t[a];if(h.errors)console.warn(`Entity '${e.name}' has errors in script '${h.name}'. Script will not be loaded!`);else{let t=`${h.source} \n return ${u};`,a=new Function(l,o,t).bind(e)(n,i,r,s);for(let t in a)a[t]&&(void 0!==c[t]?c[t].push(a[t].bind(e)):console.warn(`Player: Event type not supported ('${t}')`))}}}r.traverse(p),h(c.init,arguments)};let d,u,m,y=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,f=window.cancelAnimationFrame||window.mozCancelAnimationFrame,g=null;function w(){d=performance.now();try{let e=d-u,t=d-m;o===b.PLAYING&&h(c.update,{time:e,delta:t})}catch(e){console.error(e.message||e,e.stack||"")}if(window.activeCamera=s,i.render(r,s),!0===t.wantsScreenshot){let e=a.name+" "+(new Date).toLocaleString()+".png",s="image/png",r=i.domElement.toDataURL(s);z.saveImage(r,e),t.wantsScreenshot=!1}m=d,g=y(w)}function x(e){h(c.keydown,e)}function v(e){h(c.keyup,e)}function S(e){h(c.pointerdown,e)}function M(e){h(c.pointerup,e)}function C(e){h(c.pointermove,e)}this.play=function(){u=m=performance.now(),o=b.PLAYING,g=y(w)},this.pause=function(){o===b.PLAYING?o=b.PAUSED:o===b.PAUSED&&(o=b.PLAYING)},this.stop=function(){o=b.STOPPED,document.removeEventListener("keydown",x),document.removeEventListener("keyup",v),document.removeEventListener("pointerdown",S),document.removeEventListener("pointerup",M),document.removeEventListener("pointermove",C),D.clearObject(s),D.clearObject(r);for(let e in c)c[e].length=0;g&&(f(g),g=null)},this.getRenderer=function(){return i},this.appState=function(){return o},this.setCamera=function(e){s=e},this.setPixelRatio=function(e){i.setPixelRatio(e)},this.setSize=function(e,t){this.width=e,this.height=t,s&&k.updateCamera(s,e,t),i&&i.setSize(e,t)},this.gameCoordinates=function(t){const i=this.dom.getBoundingClientRect();let r=t.clientX-i.left,n=t.clientY-i.top,a=r/i.width*(2*i.width)-i.width,o=-n/i.height*(2*i.height)+i.height,l=new e.Vector3(a,o,0);return l.unproject(s),l}}}class le{constructor(){this.entities=[],this.expand()}getEntities(e){return e>this.entities.length&&this.expand(e-this.entities.length),this.entities.splice(0,e)}getEntity(){return this.entities.length||this.expand(),this.entities.pop()}recycle(e){e.destroy(),this.entities.push(e)}expand(e=10){for(let t=0;t<e;t++)this.entities.push(new ie)}}class ce{static absolute(e){e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z)}static noZero(e,t=.001){M.fuzzyFloat(e.x,0,t)&&(e.x=e.x<0?-1*t:t),M.fuzzyFloat(e.y,0,t)&&(e.y=e.y<0?-1*t:t),M.fuzzyFloat(e.z,0,t)&&(e.z=e.z<0?-1*t:t)}static printOut(e,t=""){""!==t&&(t+=" - "),console.info(`${t}X: ${e.x}, Y: ${e.y}, Z: ${e.z}`)}static round(e,t=0){const i=Math.pow(10,t);e.x=Math.round(e.x*i)/i,e.y=Math.round(e.y*i)/i,e.z=Math.round(e.z*i)/i}static sanity(e){isNaN(e.x)&&(e.x=0),isNaN(e.y)&&(e.y=0),isNaN(e.z)&&(e.z=0)}}const he=[new e.Vector2,new e.Vector2,new e.Vector2],de=[new e.Vector3,new e.Vector3,new e.Vector3],ue=new e.Vector3;class pe{static addAttribute(t,i="color",s=3,r=0){if(!t.getAttribute(i)){let n=new Float32Array(t.attributes.position.count*s).fill(r);const a=new e.BufferAttribute(n,s,!0).setUsage(e.DynamicDrawUsage);t.setAttribute(i,a)}return t}static coloredMesh(e){if(!e.geometry)return e;if(!e.material)return e;let t=e.material;!0!==Array.isArray(t)&&(t=[e.material]);for(let e=0;e<t.length;e++)!0!==t[e].vertexColors&&(t[e].vertexColors=!0,t[e].needsUpdate=!0);return pe.addAttribute(e.geometry,"color",3,1),e}static modelSize(t,i="max"){let s=new e.Vector3;return t.computeBoundingBox(),t.boundingBox.getSize(s),"max"===i?Math.max(s.x,s.y,s.z):Math.min(s.x,s.y,s.z)}static repeatTexture(e,t,i){if(e&&e.attributes&&e.attributes.uv&&e.attributes.uv.array){for(let s=0;s<e.attributes.uv.array.length;s+=2)e.attributes.uv.array[s+0]*=t,e.attributes.uv.array[s+1]*=i;e.attributes.uv.needsUpdate=!0}}static uvFlip(e,t=!0,i=!0){if(e&&e.isBufferGeometry&&void 0!==e.attributes.uv)for(let s=0;s<e.attributes.uv.array.length;s+=2){let r=e.attributes.uv.array[s+0],n=e.attributes.uv.array[s+1];t&&(r=1-r),i&&(n=1-n),e.attributes.uv.array[s+0]=r,e.attributes.uv.array[s+1]=n}}static uvMapCube(t,i,s=!1){if(s&&null!==t.index){const e=t.toNonIndexed();t.dispose(),t=e}void 0===i&&(i=new e.Matrix4);let r=pe.modelSize(t),n=r/2,a=new e.Box3(new e.Vector3(-n,-n,-n),new e.Vector3(n,n,n)),o=new e.Vector3;t.boundingBox.getCenter(o);const l=(new e.Matrix4).makeTranslation(-o.x,-o.y,-o.z),c=[];c.length=2*t.attributes.position.array.length/3;const h=t.attributes.position.array;if(t.index)for(let i=0;i<t.index.array.length;i+=3){const s=t.index.array[i+0],r=t.index.array[i+1],n=t.index.array[i+2];d(new e.Vector3(h[3*s+0],h[3*s+1],h[3*s+2]),new e.Vector3(h[3*r+0],h[3*r+1],h[3*r+2]),new e.Vector3(h[3*n+0],h[3*n+1],h[3*n+2])),c[2*s+0]=he[0].x,c[2*s+1]=he[0].y,c[2*r+0]=he[1].x,c[2*r+1]=he[1].y,c[2*n+0]=he[2].x,c[2*n+1]=he[2].y}else for(let i=0;i<t.attributes.position.array.length;i+=9){d(new e.Vector3(h[i+0],h[i+1],h[i+2]),new e.Vector3(h[i+3],h[i+4],h[i+5]),new e.Vector3(h[i+6],h[i+7],h[i+8]));const t=i/3,s=t+1,r=t+2;c[2*t+0]=he[0].x,c[2*t+1]=he[0].y,c[2*s+0]=he[1].x,c[2*s+1]=he[1].y,c[2*r+0]=he[2].x,c[2*r+1]=he[2].y}return void 0===t.attributes.uv&&t.addAttribute("uv",new e.Float32BufferAttribute(c,2)),t.attributes.uv.array=new Float32Array(c),t.attributes.uv.needsUpdate=!0,t;function d(t,n,o){t.applyMatrix4(l).applyMatrix4(i),n.applyMatrix4(l).applyMatrix4(i),o.applyMatrix4(l).applyMatrix4(i);const c=new e.Vector3;var h,d,u,p;if(h=c,d=t,u=n,p=o,ue.subVectors(d,u),h.subVectors(u,p),h.cross(ue).normalize(),ce.round(h,5),he[0].set(0,0,0),he[1].set(0,0,0),he[2].set(0,0,0),s){let e=c.z<0;e=e&&Math.abs(c.y)<.866,e=e&&Math.abs(c.x)<.866,e&&(he[0].x=(t.x-a.min.x)/r,he[0].y=(t.y-a.min.y)/r,he[1].x=(n.x-a.min.x)/r,he[1].y=(n.y-a.min.y)/r,he[2].x=(o.x-a.min.x)/r,he[2].y=(o.y-a.min.y)/r)}else c.x=Math.abs(c.x),c.y=Math.abs(c.y),c.z=Math.abs(c.z),c.y>c.x&&c.y>c.z?(he[0].x=(t.x-a.min.x)/r,he[0].y=(a.max.z-t.z)/r,he[1].x=(n.x-a.min.x)/r,he[1].y=(a.max.z-n.z)/r,he[2].x=(o.x-a.min.x)/r,he[2].y=(a.max.z-o.z)/r):c.x>c.y&&c.x>c.z?(he[0].x=(t.z-a.min.z)/r,he[0].y=(t.y-a.min.y)/r,he[1].x=(n.z-a.min.z)/r,he[1].y=(n.y-a.min.y)/r,he[2].x=(o.z-a.min.z)/r,he[2].y=(o.y-a.min.y)/r):c.z>c.y&&c.z>c.x&&(he[0].x=(t.x-a.min.x)/r,he[0].y=(t.y-a.min.y)/r,he[1].x=(n.x-a.min.x)/r,he[1].y=(n.y-a.min.y)/r,he[2].x=(o.x-a.min.x)/r,he[2].y=(o.y-a.min.y)/r)}}static uvMapSphere(t,i="uv"){if(null!==t.index){const e=t.toNonIndexed();e.uuid=t.uuid,e.name=t.name,t.dispose(),t=e}const s=[];s.length=2*t.attributes.position.array.length/3;const r=!(void 0===t.attributes.uv);r||t.addAttribute("uv",new e.Float32BufferAttribute(s,2));const n=!r||"u"===i||"uv"===i,a=!r||"v"===i||"uv"===i,o=t.attributes.position.array;for(let e=0;e<t.attributes.position.array.length;e+=9){de[0].set(o[e+0],o[e+1],o[e+2]),de[1].set(o[e+3],o[e+4],o[e+5]),de[2].set(o[e+6],o[e+7],o[e+8]);let t=e/3;for(let e=0;e<3;e++){const i=c(de[e]);if(0===i.theta&&(0===i.phi||i.phi===Math.PI)){const e=0===i.phi?"1":"0";i.theta=c(de[e]).theta}l(i,t,e),t++}let i=!1;if(Math.abs(he[0].x-he[1].x)>.75&&(i=!0),Math.abs(he[0].x-he[2].x)>.75&&(i=!0),Math.abs(he[1].x-he[0].x)>.75&&(i=!0),Math.abs(he[1].x-he[2].x)>.75&&(i=!0),Math.abs(he[2].x-he[0].x)>.75&&(i=!0),Math.abs(he[2].x-he[1].x)>.75&&(i=!0),i){let t=e/3;for(let e=0;e<3;e++){s[2*t]>.75&&(s[2*t]=0),t++}}}return t.attributes.uv.array=new Float32Array(s),t.attributes.uv.needsUpdate=!0,t;function l(i,r,o){const l={x:((c=i).theta+Math.PI)/(2*Math.PI),y:c.phi/Math.PI};var c;const h=new e.Vector2(1-l.x,1-l.y),d=2*r+0,u=2*r+1;s[d]=n?h.x:t.attributes.uv.array[d],s[u]=a?h.y:t.attributes.uv.array[u],he[o].x=s[d],he[o].y=s[u]}function c(e){let t=e.x*e.x+e.y*e.y+e.z*e.z,i=Math.sqrt(t);return{r:i,theta:Math.atan2(e.z,e.x),phi:Math.acos(e.y/i)}}}}const me=new e.Color,ye=new e.Vector3;class fe{static createFromPaths(t,s,r,n=""){let a=0,o=0;if(s.forEach((s=>{let r=s.userData.style.fill,l=s.userData.style.fillOpacity;if(l||0===l||(l=1),void 0!==r&&"none"!==r){i.createShapes(s).forEach((i=>{let s=`Fill ${o}`;""!==n&&(s=n+" "+s);const c=new ie(s),h=.001;function d(e){e.v0&&e.v0.multiplyScalar(h),e.v1&&e.v1.multiplyScalar(h),e.v2&&e.v2.multiplyScalar(h),e.v3&&e.v3.multiplyScalar(h),e.aX&&(e.aX*=h),e.aY&&(e.aY*=h),e.xRadius&&(e.xRadius*=h),e.yRadius&&(e.yRadius*=h)}for(let e=0;e<i.curves.length;e++)d(i.curves[e]);for(let e=0;e<i.holes.length;e++)for(let t=0;t<i.holes[e].curves.length;t++)d(i.holes[e].curves[t]);const u=new e.ExtrudeGeometry(i,{depth:.256,bevelEnabled:!1,bevelThickness:.25,bevelSegments:8,curveSegments:16,steps:4});u.name=s,u.translate(0,0,-.128),u.scale(1,-1,-1),u.computeBoundingBox(),u.boundingBox.getCenter(ye),u.center(),c.position.copy(ye),pe.uvFlip(u,!1,!0),c.addComponent("geometry",u),c.addComponent("material",{style:"standard",side:"FrontSide",color:me.setStyle(r).getHex(),opacity:l}),c.position.z=a,t.add(c),a+=.001,o++}))}})),t.children&&t.children.length>0){const i=new e.Vector3;D.computeCenter(t.children,i);for(let e of t.children)e.position.x-=i.x,e.position.y-=i.y}t.name=n,r&&"function"==typeof r&&r()}static createFromFile(e,t){const s=new ie;return(new i).load(e,(function(i){fe.createFromPaths(s,i.paths,t,R.nameFromUrl(e))})),s}}class ge{static get NAMES(){return Ue}constructor(e=16777215,t,i,s=""){this.isColor=!0,this.isIris=!0,this.type="Color",this.r=1,this.g=1,this.b=1,this.set(e,t,i,s)}copy(e){return this.set(e)}set(e=0,t,i,s=""){if(0===arguments.length)return this.set(0);if(null==e||Number.isNaN(e))(t||i)&&console.warn(`Iris: Passed some valid arguments, however 'r' was ${e}`);else if(void 0===t&&void 0===i){let i=e;if("number"==typeof i||0===i)return this.setHex(i);if(i&&(void 0!==(r=i).r&&void 0!==r.g&&void 0!==r.b))return this.setRGBF(i.r,i.g,i.b);if(i&&be(i))return this.setHSL(360*i.h,i.s,i.l);if(i&&we(i))return this.setRYB(255*i.r,255*i.y,255*i.b);if(Array.isArray(i)&&i.length>2){let e=typeof t===number&&t>0?t:0;return this.setRGBF(i[e],i[e+1],i[e+2])}if("string"==typeof i)return this.setStyle(i)}else switch(s){case"rgb":return this.setRGB(e,t,i);case"hsl":return this.setHSL(e,t,i);case"ryb":return this.setRYB(e,t,i);default:return this.setRGBF(e,t,i)}var r;return this}setColorName(e){const t=Ue[e.toLowerCase()];return t?this.setHex(t):(console.warn(`Iris: Unknown color ${e}`),this)}setHex(e){((e=Math.floor(e))>16777215||e<0)&&(console.warn(`Iris: Given decimal outside of range, value was ${e}`),e=xe(e,0,16777215));let t=(16711680&e)>>16,i=(65280&e)>>8,s=255&e;return this.setRGB(t,i,s)}setHSL(e,t,i){e=Pe(e,0,360),t=xe(t,0,1),i=xe(i,0,1);let s=(1-Math.abs(2*i-1))*t,r=s*(1-Math.abs(e/60%2-1)),n=i-s/2,a=0,o=0,l=0;return e<60?(a=s,o=r,l=0):60<=e&&e<120?(a=r,o=s,l=0):120<=e&&e<180?(a=0,o=s,l=r):180<=e&&e<240?(a=0,o=r,l=s):240<=e&&e<300?(a=r,o=0,l=s):300<=e&&(a=s,o=0,l=r),this.setRGBF(a+n,o+n,l+n),this}setRandom(){return this.setRGBF(Math.random(),Math.random(),Math.random())}setRGB(e,t,i){return this.setRGBF(e/255,t/255,i/255)}setRGBF(e,t,i){return this.r=xe(e,0,1),this.g=xe(t,0,1),this.b=xe(i,0,1),this}setRYB(e,t,i){let s=Ge(xe(e,0,255),xe(t,0,255),xe(i,0,255),255,Ne.RYB_TO_RGB);return this.setHex(s)}setScalar(e){return this.setRGB(e,e,e)}setScalarF(e){return this.setRGBF(e,e,e)}setStyle(e){let t;if(t=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let e;const i=t[1],s=t[2];switch(i){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s)){let t=Math.min(255,parseInt(e[1],10)),i=Math.min(255,parseInt(e[2],10)),s=Math.min(255,parseInt(e[3],10));return this.setRGB(t,i,s)}if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s)){let t=Math.min(100,parseInt(e[1],10))/100,i=Math.min(100,parseInt(e[2],10))/100,s=Math.min(100,parseInt(e[3],10))/100;return this.setRGBF(t,i,s)}break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s)){const t=parseFloat(e[1]),i=parseInt(e[2],10)/100,s=parseInt(e[3],10)/100;return this.setHSL(t,i,s)}}}else if(t=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=t[1],i=e.length;if(3===i){let t=parseInt(e.charAt(0)+e.charAt(0),16),i=parseInt(e.charAt(1)+e.charAt(1),16),s=parseInt(e.charAt(2)+e.charAt(2),16);return this.setRGB(t,i,s)}if(6===i){let t=parseInt(e.charAt(0)+e.charAt(1),16),i=parseInt(e.charAt(2)+e.charAt(3),16),s=parseInt(e.charAt(4)+e.charAt(5),16);return this.setRGB(t,i,s)}}return e&&e.length>0?this.setColorName(e):this}cssString(e){return"rgb("+this.rgbString(e)+")"}hex(){return(this.red()<<16)+(this.green()<<8)+this.blue()}hexString(e){return void 0!==e&&"number"==typeof value||(e=this.hex()),ge.hexString(e)}static hexString(e=0){return"#"+("000000"+(e>>>0).toString(16)).slice(-6)}static randomHex(){return Ve.setRandom().hex()}rgbString(e){let t=this.red()+", "+this.green()+", "+this.blue();return null!=e?t+", "+e:t}toJSON(){return this.hex()}clone(){return new this.constructor(this.r,this.g,this.b)}getHSL(e){if(!e||!be(e))return{h:ze(this.hex()),s:Ce(this.hex()),l:Ae(this.hex())};e.h=ze(this.hex()),e.s=Ce(this.hex()),e.l=Ae(this.hex())}getRGB(e){if(!e||!be(e))return{r:this.r,g:this.g,b:this.b};e.r=this.r,e.g=this.g,e.b=this.b}getRYB(e){let t=Ge(this.r,this.g,this.b,1,Ne.RGB_TO_RYB);if(!e||!we(e))return{r:ve(t),y:Se(t),b:ke(t)};e.r=ve(t),e.y=Se(t),e.b=ke(t)}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}red(){return xe(Math.floor(255*this.r),0,255)}green(){return xe(Math.floor(255*this.g),0,255)}blue(){return xe(Math.floor(255*this.b),0,255)}redF(){return this.r}greenF(){return this.g}blueF(){return this.b}hue(){return Me(this.hex())}saturation(){return Ce(this.hex())}lightness(){return Ae(this.hex())}hueF(){return ze(this.hex())}hueRYB(){for(let e=1;e<We.length;e++)if(We[e]>this.hue())return e-2}add(e){return e.isColor||console.warn("Iris: add() was not called with a 'Color' object"),this.setRGBF(this.r+e.r,this.g+e.g,this.b+e.b)}addScalar(e){return this.setRGB(this.red()+e,this.green()+e,this.blue()+e)}addScalarF(e){return this.setRGBF(this.r+e,this.g+e,this.b+e)}brighten(e=.5){let t=Me(this.hex()),i=Ce(this.hex()),s=Ae(this.hex());return s+=(1-s)*e,this.setHSL(t,i,s),this}darken(e=.5){let t=Me(this.hex()),i=Ce(this.hex()),s=Ae(this.hex())*e;return this.setHSL(t,i,s)}greyscale(e=1,t="luminosity"){return this.grayscale(e,t)}grayscale(e=1,t="luminosity"){let i=0;"luminosity"===t&&(i=.21*this.r+.72*this.g+.07*this.b),i=(this.r+this.g+this.b)/3,e=xe(e,0,1);let s=this.r*(1-e)+e*i,r=this.g*(1-e)+e*i,n=this.b*(1-e)+e*i;return this.setRGBF(s,r,n)}hslOffset(e,t,i){return this.setHSL(this.hue()+e,this.saturation()+t,this.lightness()+i)}mix(e,t=.5){e.isColor||console.warn("Iris: mix() was not called with a 'Color' object"),t=xe(t,0,1);let i=this.r*(1-t)+t*e.r,s=this.g*(1-t)+t*e.g,r=this.b*(1-t)+t*e.b;return this.setRGBF(i,s,r)}multiply(e){return e.isColor||console.warn("Iris: multiply() was not called with a 'Color' object"),this.setRGBF(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyScalar(e){return this.setRGBF(this.r*e,this.g*e,this.b*e)}rgbComplementary(){return this.rgbRotateHue(180)}rgbRotateHue(e=90){let t=Pe(this.hue()+e);return this.setHSL(t,this.saturation(),this.lightness())}rybAdjust(){return this.setHSL(Me(Ie(this.hue(),_e.RYB)),this.saturation(),this.lightness())}rybComplementary(){return this.rybRotateHue(180)}rybRotateHue(e=90){let t=Pe(this.hueRYB()+e);return this.setHSL(Me(Ie(t,_e.RYB)),this.saturation(),this.lightness())}subtract(e){return e.isColor||console.warn("Iris: subtract() was not called with a 'Color' object"),this.setRGBF(this.r-e.r,this.g-e.g,this.b-e.b)}equals(e){return e.isColor||console.warn("Iris: equals() was not called with a 'Color' object"),Be(this.r,e.r)&&Be(this.g,e.g)&&Be(this.b,e.b)}isEqual(e){return this.equals(e)}isDark(){const e=this.hue(),t=this.lightness();return t<.6&&(e>=210||e<=27)||t<=.32}isLight(){return!this.isDark()}}function be(e){return void 0!==e.h&&void 0!==e.s&&void 0!==e.l}function we(e){return void 0!==e.r&&void 0!==e.y&&void 0!==e.b}function xe(e,t,i){return Math.max(t,Math.min(i,e))}function ve(e){return function(e){return xe((16711680&e)>>16,0,255)}(e)/255}function Se(e){return function(e){return xe((65280&e)>>8,0,255)}(e)/255}function ke(e){return function(e){return xe(255&e,0,255)}(e)/255}function Me(e){return Fe(e,"h")}function ze(e){return Me(e)/360}function Ce(e){return Fe(e,"s")}function Ae(e){return Fe(e,"l")}function Be(e,t,i=.0015){return e<t+i&&e>t-i}function Pe(e,t=0,i=360){for(;e>=i;)e-=i-t;for(;e<t;)e+=i-t;return e}let Ee,Oe,Te,je;function Fe(e,t="h"){if(e!==Ee){if(null==e)return 0;const t=ve(e),i=Se(e),s=ke(e),r=Math.max(t,i,s),n=Math.min(t,i,s),a=r-n;if(je=(r+n)/2,0===a)Oe=Te=0;else{switch(Te=je<=.5?a/(r+n):a/(2-r-n),r){case t:Oe=(i-s)/a+(i<s?6:0);break;case i:Oe=(s-t)/a+2;break;case s:Oe=(t-i)/a+4}Oe=Math.round(60*Oe),Oe<0&&(Oe+=360)}Ee=e}switch(t){case"h":return Oe;case"s":return Te;case"l":return je;default:console.warn(`Iris: Unknown channel (${t}) requested in hsl()`)}return 0}const De=new ge,Re=new ge,Ve=new ge;function Ie(e,t=_e.RYB){let i=360/t.length,s=i,r=0;for(let n=0;n<t.length;n++){if(e<s){let n=(s-e)/i;return De.set(t[r+1]),De.mix(Re.set(t[r]),n).hex()}s+=i,r+=1}}const Le=new ge;function Ge(e,t,i,s=255,r=Ne.RYB_TO_RGB){e=xe(e/s,0,1),t=xe(t/s,0,1),i=xe(i/s,0,1);let n=r[0],a=r[1],o=r[2],l=r[3],c=r[4],h=r[5],d=r[6],u=r[7],p=1-e,m=1-t,y=1-i,f=p*m*y,g=p*m*i,b=p*t*y,w=e*m*y,x=p*t*i,v=e*m*i,S=e*t*y,k=e*t*i,M=f*n[0]+g*a[0]+b*o[0]+w*l[0]+x*c[0]+v*h[0]+S*d[0]+k*u[0],z=f*n[1]+g*a[1]+b*o[1]+w*l[1]+x*c[1]+v*h[1]+S*d[1]+k*u[1],C=f*n[2]+g*a[2]+b*o[2]+w*l[2]+x*c[2]+v*h[2]+S*d[2]+k*u[2];return Le.set(M,z,C,"gl").hex()}const Ne={RYB_TO_RGB:[[1,1,1],[.163,.373,.6],[1,1,0],[1,0,0],[0,.66,.2],[.5,0,.5],[1,.5,0],[0,0,0]],RGB_TO_RYB:[[1,1,1],[0,0,1],[0,1,.483],[1,0,0],[0,.053,.21],[.309,0,.469],[0,1,0],[0,0,0]]},_e={RYB:[16711680,16730368,16741376,16749056,16755200,16760576,16765696,16771072,16776960,13432320,10481152,6808320,52224,44900,39321,745892,1196203,1776563,3740847,5443501,7408042,10879142,13434996,14942277,16711680]},We=[0,1,2,3,5,6,7,8,9,10,11,13,14,15,16,17,18,19,19,20,21,21,22,23,23,24,25,25,26,27,27,28,28,29,29,30,30,31,31,32,32,32,33,33,34,34,35,35,35,36,36,37,37,37,38,38,38,39,39,40,40,40,41,41,41,42,42,42,43,43,43,44,44,44,45,45,45,46,46,46,47,47,47,47,48,48,48,49,49,49,50,50,50,51,51,51,52,52,52,53,53,53,54,54,54,55,55,55,56,56,56,57,57,57,58,58,59,59,59,60,60,61,61,62,63,63,64,65,65,66,67,68,68,69,70,70,71,72,72,73,73,74,75,75,76,77,77,78,79,79,80,81,82,82,83,84,85,86,87,88,88,89,90,91,92,93,95,96,98,100,102,104,105,107,109,111,113,115,116,118,120,122,125,127,129,131,134,136,138,141,143,145,147,150,152,154,156,158,159,161,163,165,166,168,170,171,173,175,177,178,180,182,184,185,187,189,191,192,194,196,198,199,201,203,205,206,207,208,209,210,212,213,214,215,216,217,218,219,220,221,222,223,224,226,227,228,229,230,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,251,252,253,254,255,256,257,257,258,259,260,260,261,262,263,264,264,265,266,267,268,268,269,270,271,272,273,274,274,275,276,277,278,279,280,282,283,284,286,287,289,290,292,293,294,296,297,299,300,302,303,305,307,309,310,312,314,316,317,319,321,323,324,326,327,328,329,330,331,332,333,334,336,337,338,339,340,341,342,343,344,345,347,348,349,350,352,353,354,355,356,358,359,999],Ue={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,transparent:0,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};class He extends e.BufferGeometry{constructor(t=1,i=1,s=2,r=12,n=1,a=5,o=5,l,c){super(),this.type="CapsuleGeometry",this.parameters={radiusTop:t,radiusBottom:i,height:s,radialSegments:r,heightSegments:n,thetaStart:l,thetaLength:c},t=void 0!==t?t:1,i=void 0!==i?i:1,s=void 0!==s?s:2,t=M.clamp(t,.001,s),i=M.clamp(i,.001,s),s<.001&&(s=.001),r=Math.floor(r)||12,n=Math.floor(n)||1,a=Math.floor(a)||5,o=Math.floor(o)||5,l=void 0!==l?l:0,c=void 0!==c?c:2*Math.PI;let h=Math.acos((i-t)/s),d=(r+1)*(n+1+o+a),u=r*(n+o+a)*2*3,p=new e.BufferAttribute(new(u>65535?Uint32Array:Uint16Array)(u),1),m=new e.BufferAttribute(new Float32Array(3*d),3),y=new e.BufferAttribute(new Float32Array(3*d),3),f=new e.BufferAttribute(new Float32Array(2*d),2),g=0,b=0,w=[],x=s/2;!function(){let d,u,v=new e.Vector3,S=new e.Vector3,k=Math.cos(h),M=Math.sin(h),z=new e.Vector2(t*M,x+t*k).sub(new e.Vector2(i*M,i*k-x)).length(),C=t*h+z+i*(Math.PI/2-h),A=0;for(u=0;u<=a;u++){let e=[],i=Math.PI/2-h*(u/a);A+=t*h/a;let s=Math.cos(i),n=Math.sin(i),o=s*t;for(d=0;d<=r;d++){let i=d/r,a=i*c+l,h=Math.sin(a),u=Math.cos(a);S.x=o*h,S.y=x+n*t,S.z=o*u,m.setXYZ(g,S.x,S.y,S.z),v.set(s*h,n,s*u),y.setXYZ(g,v.x,v.y,v.z),f.setXY(g,i,1-A/C),e.push(g),g++}w.push(e)}let B=s+k*t-k*i,P=M*(i-t)/B;for(u=1;u<=n;u++){let e=[];A+=z/n;let s=M*(u*(i-t)/n+t);for(d=0;d<=r;d++){let i=d/r,a=i*c+l,o=Math.sin(a),h=Math.cos(a);S.x=s*o,S.y=x+k*t-u*B/n,S.z=s*h,m.setXYZ(g,S.x,S.y,S.z),v.set(o,P,h).normalize(),y.setXYZ(g,v.x,v.y,v.z),f.setXY(g,i,1-A/C),e.push(g),g++}w.push(e)}for(u=1;u<=o;u++){let e=[],t=Math.PI/2-h-(Math.PI-h)*(u/o);A+=i*h/o;let s=Math.cos(t),n=Math.sin(t),a=s*i;for(d=0;d<=r;d++){let t=d/r,o=t*c+l,h=Math.sin(o),u=Math.cos(o);S.x=a*h,S.y=n*i-x,S.z=a*u,m.setXYZ(g,S.x,S.y,S.z),v.set(s*h,n,s*u),y.setXYZ(g,v.x,v.y,v.z),f.setXY(g,t,1-A/C),e.push(g),g++}w.push(e)}for(d=0;d<r;d++)for(u=0;u<a+n+o;u++){let e=w[u][d],t=w[u+1][d],i=w[u+1][d+1],s=w[u][d+1];p.setX(b,e),b++,p.setX(b,t),b++,p.setX(b,s),b++,p.setX(b,t),b++,p.setX(b,i),b++,p.setX(b,s),b++}}(),this.setIndex(p),this.setAttribute("position",m),this.setAttribute("normal",y),this.setAttribute("uv",f)}static fromPoints(t,i,s,r,n,a,o,l,c,h){let d=null,u=null,p=null,m=null;u=t,d=i,m=s,p=r;const y=d,f=u,g=p,b=m,w=new e.Vector3(y.x,y.y,y.z),x=new e.Vector3(f.x,f.y,f.z),v=g,S=b;let k=w.distanceTo(x);if(k<Math.abs(g-b)){let t=new e.SphereGeometry(b,n,l,c,h);return t.translate(b.x,b.y,b.z),t}const M=Math.acos((S-v)/k),z=Math.cos(M),C=new e.Matrix4,A=new e.Quaternion,B=new e.Vector3(0,1,0),P=new e.Vector3;P.subVectors(w,x),P.normalize(),A.setFromUnitVectors(B,P),C.makeRotationFromQuaternion(A);const E=new e.Matrix4,O=new e.Vector3;O.subVectors(w,x),O.normalize();let T=new e.Vector3;T=w,T.addScaledVector(O,z*v);let j=new e.Vector3;j=x,j.addScaledVector(O,z*S);const F=new e.Vector3;F.subVectors(j,T),F.normalize();const D=new e.Vector3;D.lerpVectors(j,T,.5),E.makeTranslation(D.x,D.y,D.z);let R=new He(S,v,k,n,a,o,l,c,h);return R.applyMatrix(C),R.applyMatrix(E),R}}class qe extends e.BufferGeometry{constructor(t=1,i=1,s=1,r=8,n=1,a=!1,o=0,l=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:i,height:s,radialSegments:r,heightSegments:n,openEnded:a,thetaStart:o,thetaLength:l};const c=this;r=Math.floor(r),n=Math.floor(n);const h=[],d=[],u=[],p=[];let m=0;const y=[],f=s/2;let g=0;function b(s){const n=m,a=new e.Vector2,y=new e.Vector3;let b=0;const w=!0===s?t:i,x=!0===s?1:-1;for(let e=1;e<=r;e++)d.push(0,f*x,0),u.push(0,x,0),p.push(.5,.5),m++;const v=m;for(let e=0;e<=r;e++){const t=e/r*l+o,i=Math.cos(t),s=Math.sin(t);y.x=w*s,y.y=f*x,y.z=w*i,d.push(y.x,y.y,y.z),u.push(0,x,0),a.x=.5*i+.5,a.y=.5*s*x+.5,p.push(a.x,a.y),m++}for(let e=0;e<r;e++){const t=n+e,i=v+e;!0===s?h.push(i,i+1,t):h.push(i+1,i,t),b+=3}c.addGroup(g,b,!0===s?1:2),g+=b}!function(){const a=new e.Vector3,b=new e.Vector3;let w=0;const x=(i-t)/s;for(let e=0;e<=n;e++){const c=[],h=e/n,g=h*(i-t)+t;for(let e=0;e<=r;e++){const t=e/r,i=t*l+o,n=Math.sin(i),y=Math.cos(i);b.x=g*n,b.y=-h*s+f,b.z=g*y,d.push(b.x,b.y,b.z),a.set(n,x,y).normalize(),u.push(a.x,a.y,a.z),p.push(t,1-h),c.push(m++)}y.push(c)}for(let t=0;t<r;t++)for(let i=0;i<n;i++){const s=y[i][t],r=y[i+1][t],n=y[i+1][t+1],a=y[i][t+1],o=new e.Vector3(d[3*s+0],d[3*s+1],d[3*s+2]),l=new e.Vector3(d[3*r+0],d[3*r+1],d[3*r+2]),c=new e.Vector3(d[3*n+0],d[3*n+1],d[3*n+2]),u=new e.Vector3(d[3*a+0],d[3*a+1],d[3*a+2]),p=new e.Triangle(o,l,u),m=new e.Triangle(l,c,u);p.getArea()>1e-4&&(h.push(s,r,a),w+=3),m.getArea()>1e-4&&(h.push(r,n,a),w+=3)}c.addGroup(g,w,0),g+=w}(),a||(t>0&&b(!0),i>0&&b(!1)),this.setIndex(h),this.setAttribute("position",new e.Float32BufferAttribute(d,3)),this.setAttribute("normal",new e.Float32BufferAttribute(u,3)),this.setAttribute("uv",new e.Float32BufferAttribute(p,2))}static fromJSON(e){return new qe(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Je extends e.ExtrudeGeometry{constructor(t,i){let s=new e.Shape;!function(e){e.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)e.lineTo(t[i].x,t[i].y);e.lineTo(t[0].x,t[0].y)}(s);super(s,{steps:2,depth:i,bevelEnabled:!1}),this.vertices=t,this.height=i}clone(){return new this.constructor(this.vertices,this.height).copy(this)}}function $e(t){t.transparent=!0,t.resolution=new e.Vector2(1024,1024),t.depthTest=!0,t.depthWrite=!1,t.polygonOffset=!0,t.polygonOffsetFactor=1,t.side=e.DoubleSide,t.alphaToCoverage=!0}const Ye=new e.Quaternion,Qe=new e.Vector3,Xe=new e.Vector3,Ke=new e.Vector3,Ze=new e.Vector3,et=new e.Box3,tt=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);class it extends e.LineSegments{constructor(t,i,s,r,n,a,o=16777215){const l=[t,i,s,r,n,a],c=new e.BufferGeometry;c.setIndex([0,1]),c.setAttribute("position",new e.Float32BufferAttribute(l,3));const h=new e.LineBasicMaterial({color:o});$e(h),h.wireframe=!0,super(c,h)}clone(){const e=this.geometry.attributes.position.array;return e[0]=point1.x,e[1]=point1.y,e[2]=point1.z,e[3]=point2.x,e[4]=point2.y,e[5]=point2.z,new this.constructor(e[0],e[1],e[2],e[3],e[4],e[5]).copy(this,!0)}setPoints(e,t){ce.sanity(e),ce.sanity(t);const i=this.geometry.attributes.position.array;i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=t.x,i[4]=t.y,i[5]=t.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingSphere()}}class st extends s{constructor(t,i,s,a,o,l,c=1,h=16777215){const d=new r,u=new n({color:h,linewidth:c});$e(u);const p=[t,i,s,a,o,l];d.setPositions(p),super(d,u),this.computeLineDistances(),this.scale.set(1,1,1),this.point1=new e.Vector3(t,i,s),this.point2=new e.Vector3(a,o,l)}clone(){return new this.constructor(this.point1.x,this.point1.y,this.point1.z,this.point2.x,this.point2.y,this.point2.z).copy(this,!0)}setPoints(e,t){ce.sanity(e),ce.sanity(t),this.point1.copy(e),this.point2.copy(t);const i=[e.x,e.y,e.z,t.x,t.y,t.z];this.geometry.setPositions(i),this.computeLineDistances()}}class rt extends e.LineSegments{constructor(t,i=16777215,s=1,r=!1){const n=new e.WireframeGeometry,a=new e.LineBasicMaterial({color:i,opacity:s});$e(a),super(n,a),this._positions=new Float32Array(24),this.points=[];for(let t=0;t<8;t++)this.points.push(new e.Vector3);t&&this.updateFromObject(t,r),this.clone=function(){return new this.constructor(t,i,s,r).copy(this,!0)}}disableDepthTest(){this.material.depthTest=!1}updateFromObject(t,i){let s=t.clone();i&&(t.getWorldPosition(Xe),t.getWorldQuaternion(Ye),t.getWorldScale(Qe),s.lookAtCamera=!1,s.position.set(0,0,0),s.rotation.set(0,0,0),s.scale.set(1,1,1),s.updateMatrixWorld(!0)),et.setFromObject(s);const r=et.min,n=et.max;ce.sanity(et.min),ce.sanity(et.max);let a=this._positions;a[0]=n.x,a[1]=n.y,a[2]=n.z,a[3]=r.x,a[4]=n.y,a[5]=n.z,a[6]=r.x,a[7]=r.y,a[8]=n.z,a[9]=n.x,a[10]=r.y,a[11]=n.z,a[12]=n.x,a[13]=n.y,a[14]=r.z,a[15]=r.x,a[16]=n.y,a[17]=r.z,a[18]=r.x,a[19]=r.y,a[20]=r.z,a[21]=n.x,a[22]=r.y,a[23]=r.z;const o=[];for(let e=tt.length-1;e>0;e-=2){const t=3*tt[e-0],i=3*tt[e-1];o.push(a[t+0],a[t+1],a[t+2]),o.push(a[i+0],a[i+1],a[i+2])}this.geometry.setAttribute("position",new e.Float32BufferAttribute(o,3)),i&&(this.setRotationFromQuaternion(Ye),this.scale.set(Qe.x,Qe.y,Qe.z),this.position.set(Xe.x,Xe.y,Xe.z)),this.updateMatrixWorld(!0),D.clearObject(s)}getPoints(){for(let e=0;e<8;e++){const t=3*e;this.points[e].x=this.geometry.attributes.position.array[t+0],this.points[e].y=this.geometry.attributes.position.array[t+1],this.points[e].z=this.geometry.attributes.position.array[t+2],this.localToWorld(this.points[e])}return this.points}getLocalPoints(){for(let e=0;e<8;e++){const t=3*e;this.points[e].x=this._positions[t+0],this.points[e].y=this._positions[t+1],this.points[e].z=this._positions[t+2]}return this.points}getBox3(t){const i=this.getLocalPoints();(t=t??new e.Box3).min.x=i[6].x,t.min.y=i[6].y,t.min.z=i[6].z,t.max.x=i[0].x,t.max.y=i[0].y,t.max.z=i[0].z}}class nt extends s{constructor(t,i=1,s=16777215,r=1,o=!1){const l=new a,c=new n({color:s,linewidth:i,opacity:r});$e(c),c.depthTest=!1,super(l,c),this._positions=new Float32Array(24),this.points=[];for(let t=0;t<8;t++)this.points.push(new e.Vector3);t&&this.updateFromObject(t,o),this.clone=function(){return new this.constructor(t,i,s,r,o).copy(this,!0)}}disableDepthTest(){this.material.depthTest=!1}updateFromObject(e,t){let i=e.clone();t&&(e.getWorldPosition(Xe),e.getWorldQuaternion(Ye),e.getWorldScale(Qe),i.lookAtCamera=!1,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),i.updateMatrixWorld(!0)),et.setFromObject(i);const s=et.min,r=et.max;ce.sanity(et.min),ce.sanity(et.max);let n=this._positions;n[0]=r.x,n[1]=r.y,n[2]=r.z,n[3]=s.x,n[4]=r.y,n[5]=r.z,n[6]=s.x,n[7]=s.y,n[8]=r.z,n[9]=r.x,n[10]=s.y,n[11]=r.z,n[12]=r.x,n[13]=r.y,n[14]=s.z,n[15]=s.x,n[16]=r.y,n[17]=s.z,n[18]=s.x,n[19]=s.y,n[20]=s.z,n[21]=r.x,n[22]=s.y,n[23]=s.z;const a=[];for(let e=tt.length-1;e>0;e-=2){const t=3*tt[e-0],i=3*tt[e-1];a.push(n[t+0],n[t+1],n[t+2]),a.push(n[i+0],n[i+1],n[i+2])}this.geometry.setPositions(a),t&&(this.setRotationFromQuaternion(Ye),this.scale.set(Qe.x,Qe.y,Qe.z),this.position.set(Xe.x,Xe.y,Xe.z)),this.updateMatrixWorld(!0),D.clearObject(i)}getPoints(){for(let e=0;e<8;e++){const t=3*e;this.points[e].x=this.geometry.attributes.position.array[t+0],this.points[e].y=this.geometry.attributes.position.array[t+1],this.points[e].z=this.geometry.attributes.position.array[t+2],this.localToWorld(this.points[e])}return this.points}getLocalPoints(){for(let e=0;e<8;e++){const t=3*e;this.points[e].x=this._positions[t+0],this.points[e].y=this._positions[t+1],this.points[e].z=this._positions[t+2]}return this.points}getAbsoluteSize(e){this.getSize(e),e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z)}getAverageSize(){return this.getSize(Ze),(Ze.x+Ze.y+Ze.z)/3}getBox3(t){const i=this.getLocalPoints();(t=t??new e.Box3).min.x=i[6].x,t.min.y=i[6].y,t.min.z=i[6].z,t.max.x=i[0].x,t.max.y=i[0].y,t.max.z=i[0].z}getSize(e){this.getWorldScale(Ke);const t=this.getLocalPoints();e.x=(t[0].x-t[6].x)*Math.abs(Ke.x),e.y=(t[0].y-t[6].y)*Math.abs(Ke.y),e.z=(t[0].z-t[6].z)*Math.abs(Ke.z)}getMaxSize(){return this.getSize(Ze),Math.max(Math.max(Ze.x,Ze.y),Ze.z)}}class at extends e.LineSegments{constructor(t,i,s=1,r=!1){const n=new e.WireframeGeometry(t.geometry),a=new e.LineBasicMaterial({color:i,opacity:s});$e(a),super(n,a),r&&(this.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z),this.scale.set(t.scale.x,t.scale.y,t.scale.z),this.position.set(t.position.x,t.position.y,t.position.z)),this.clone=function(){return new this.constructor(t,i,s,r).copy(this,!0)}}}class ot extends o{constructor(t,i,s,r=1,a=!1){const o=new l(t.geometry),c=new n({color:s,linewidth:i,resolution:new e.Vector2(500,500),opacity:r});$e(c),c.depthTest=!1,super(o,c),a&&(this.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z),this.scale.set(t.scale.x,t.scale.y,t.scale.z),this.position.set(t.position.x,t.position.y,t.position.z)),this.clone=function(){return new this.constructor(t,i,s,r,a).copy(this,!0)}}}class lt{fromObject(e){let t,i=new THREE.SphereGeometry(2,4,2),s=new THREE.MeshBasicMaterial({color:16711680,visible:!1});if(e.isCamera)t=new THREE.CameraHelper(e);else if(e.isPointLight)t=new THREE.PointLightHelper(e,1);else if(e.isDirectionalLight)t=new THREE.DirectionalLightHelper(e,1);else if(e.isSpotLight)t=new THREE.SpotLightHelper(e);else if(e.isHemisphereLight)t=new THREE.HemisphereLightHelper(e,1);else{if(!e.isSkinnedMesh)return;t=new THREE.SkeletonHelper(e.skeleton.bones[0])}const r=new THREE.Mesh(i,s);return r.name="picker",r.userData.object=e,t.add(r),t}}class ct extends e.Mesh{constructor(){const t=ct.SkyShader;super(new e.SphereGeometry(1),new e.ShaderMaterial({name:"SkyShader",fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:e.UniformsUtils.clone(t.uniforms),side:e.BackSide,depthTest:!1,depthWrite:!1})),this.isSky=!0,this.baseScale=500,this.scale.setScalar(this.baseScale)}copy(e,t){return super.copy(e,t),this.baseScale=e.baseScale,this.scale.setScalar(this.baseScale),this}}ct.SkyShader={uniforms:{uSky:{value:new e.Color(0,.85,.8)},uHorizon:{value:new e.Color(1,.75,.5)},uGround:{value:new e.Color(.9,.7,.5)},uScale:{value:500}},vertexShader:"\n        varying vec3 \tvWorldPosition;\n\n        void main() {\n            vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n            vWorldPosition = worldPosition.xyz;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }",fragmentShader:"\n        uniform vec3    uSky;\n        uniform vec3    uHorizon;\n        uniform vec3    uGround;\n        uniform float   uScale;\n        varying vec3    vWorldPosition;\n\n        void main() {\n            float lowerGround =         0.0;\n            float h = normalize(vWorldPosition + lowerGround).y;\n\n            ///// Sky fade (brighten at horizon)\n            float skyFade = pow(vWorldPosition.y / (uScale * 0.25), 0.4);\n            skyFade = clamp(skyFade, 0.0, 1.0);\n            vec3 sky = mix(uHorizon, uSky, skyFade);\n\n            ///// Seperates ground and sky, solid horizon: clamp(h * uScale, 0.0, 1.0)\n            float blurHorizon =         0.05;\n            float compressHorizon =     5.0;\n            float skyMix = max(pow(max(h, 0.0), blurHorizon) * compressHorizon, 0.0);\n            skyMix = clamp(skyMix, 0.0, 1.0);\n            vec3 outColor = mix(uGround, sky, skyMix);\n\n            ///// Output Color\n            gl_FragColor = vec4(outColor, 1.0);\n        }"};const ht=new e.Color(16777215),dt=[],ut=new e.Color;let pt,mt,yt;class ft extends c{constructor(t,i){super();const s=this;function r(t){let i=t.object;if(!i||!i.isObject3D)return;if(!i.visible)return;if(!D.allowSelection(i))return;let r=i.id,n=i.material,a=i.geometry,o=0;!0===n.morphTargets&&(!0===a.isBufferGeometry?o=a.morphAttributes?.position?.length>0?1:0:!0===a.isGeometry&&(o=a.morphTargets?.length>0?1:0));let l=i.isSkinnedMesh?1:0,c=o<<0|l<<1|(!0===i.isInstancedMesh?1:0)<<2|(n.side===e.FrontSide?1:0)<<3|(n.side===e.BackSide?1:0)<<4|(n.side===e.DoubleSide?1:0)<<5,h=dt[c];h||(h=new e.ShaderMaterial({defines:{USE_MAP:"",USE_UV:"",USE_LOGDEPTHBUF:""},vertexShader:e.ShaderChunk.meshbasic_vert,fragmentShader:"\n                        #include <common>\n\n                        varying vec2 vUv;\n\n                        uniform float opacity;\n                        uniform sampler2D map;\n                        uniform vec4 objectId;\n                        uniform float useMap;\n\n                        #include <logdepthbuf_pars_fragment>\n\n                        void main() {\n                            #include <logdepthbuf_fragment>\n\n                            gl_FragColor = objectId;\n\n                            if (opacity < 0.05) discard;\n\n                            if (useMap > 0.0) {\n                                vec4 texelColor = texture2D(map, vUv);\n                                if (texelColor.a < 0.05) discard;\n\n                                ///// To just render normal texture color:\n                                // gl_FragColor = texelColor;\n                            }\n                        }\n                    ",fog:!1,lights:!1}),h.side=n.side,h.skinning=l>0,h.morphTargets=o>0,h.uniforms={opacity:{value:1},map:{value:void 0},uvTransform:{value:new e.Matrix3},objectId:{value:[1,1,1,1]},useMap:{value:0}},dt[c]=h),h.uniforms.objectId.value=[(r>>24&255)/255,(r>>16&255)/255,(r>>8&255)/255,(255&r)/255],h.uniforms.useMap.value=0,n.map&&(h.uniforms.useMap.value=1,h.uniforms.map.value=n.map),h.uniformsNeedUpdate=!0,mt.renderBufferDirect(s.camera,null,a,h,i,null)}this.scene=t,this.camera=i,this.overrideMaterial=void 0,this.clearColor=void 0,this.clearAlpha=0,this.clear=!1,this.clearDepth=!1,this.needsSwap=!1,this.renderDebugView=!1,this.needPick=!1,this.x=0,this.y=0,this.pickedId=-1,pt=new e.Scene,pt.onAfterRender=function(){const e=mt.renderLists.get(s.scene,0);e.opaque.forEach(r),e.transmissive.forEach(r),e.transparent.forEach(r)},this.pickingTarget=new e.WebGLRenderTarget(1,1,{minFilter:e.NearestFilter,magFilter:e.NearestFilter,format:e.RGBAFormat,encoding:e.LinearEncoding}),this.pixelBuffer=new Uint8Array(4*this.pickingTarget.width*this.pickingTarget.height)}dispose(){this.pickingTarget.dispose()}render(e,t,i){if(!1===this.needPick&&!1===this.renderDebugView)return;mt=e;const s=e.domElement.width,r=e.domElement.height;this.camera.setViewOffset(s,r,this.x,this.y,1,1);const n=e.getRenderTarget(),a=e.getClearAlpha();e.getClearColor(ut),e.setRenderTarget(this.pickingTarget),e.setClearColor(ht),e.clear(),e.render(pt,this.camera),e.readRenderTargetPixels(this.pickingTarget,0,0,this.pickingTarget.width,this.pickingTarget.height,this.pixelBuffer),e.setRenderTarget(n),this.camera.clearViewOffset(),this.renderDebugView&&e.render(pt,this.camera),e.setClearColor(ut,a),this.needPick&&(this.pickedId=(this.pixelBuffer[0]<<24)+(this.pixelBuffer[1]<<16)+(this.pixelBuffer[2]<<8)+this.pixelBuffer[3],this.needPick=!1)}renderPickScene(e,t){mt=e;const i=e.getClearAlpha();e.getClearColor(ut),e.setClearColor(ht),e.clear(),e.render(pt,t),e.setClearColor(ut,i)}}class gt{static offscreenRenderer(t=512,i=512){return void 0===yt&&(yt=new e.WebGLRenderer({alpha:!0})),yt.setClearColor(16777215,0),yt.setSize(t,i,!1),yt}static renderGeometryToCanvas(t,i,s=16777215){const r=new e.Scene;r.add(new e.HemisphereLight(16777215,2105376,1.5));const n=new e.PerspectiveCamera(50,t.width/t.height);n.position.set(0,0,1);const a=new e.MeshStandardMaterial({color:s}),o=new e.Mesh(i,a);r.add(o),k.fitCameraToObject(n,o);const l=gt.offscreenRenderer(t.width,t.height);l.render(r,n),a.dispose();const c=t.getContext("2d");c&&(c.clearRect(0,0,t.width,t.height),c.drawImage(l.domElement,0,0,t.width,t.height))}static renderTextureToCanvas(t,i){const s=new e.Scene,r=new e.OrthographicCamera(-1,1,1,-1,0,1),n=new e.MeshBasicMaterial({map:i,alphaTest:!0}),a=new e.PlaneGeometry(2,2),o=new e.Mesh(a,n);s.add(o);const l=i.image,c=gt.offscreenRenderer(l.width,l.height);c.render(s,r),n.dispose();const h=t.getContext("2d");if(h){let e,i,s,r,n;l.width/l.height<t.width/t.height?(r=l.height>t.height?t.height:l.height,n=Math.min(1,t.height/l.height),s=l.width*n):(s=l.width>t.width?t.width:l.width,n=Math.min(1,t.width/l.width),r=l.height*n),e=(t.width-s)/2,i=(t.height-r)/2,h.clearRect(0,0,t.width,t.height),h.drawImage(c.domElement,0,0,l.width,l.height,e,i,s,r)}}}const bt=new e.Vector2(1,1);class wt{init(t){let i;switch(t.style){case"perspective":this._tanFOV=Math.tan(Math.PI/180*t.fov/2),this._windowHeight=t.fixedSize?1e3:0,i=new e.PerspectiveCamera(t.fov,1,t.nearPersp,t.farPersp);break;case"orthographic":i=new e.OrthographicCamera(t.left,t.right,t.top,t.bottom,t.nearOrtho,t.farOrtho);break;default:console.error(`Camera.init: Invalid camera type '${t.style}'`)}i&&i.isCamera?(i.position.set(0,0,5),i.lookAt(0,0,0)):console.log("Error with camera!"),this.backend=i,this.data=t,this.style=t.style}dispose(){}enable(){this.entity&&this.backend&&this.entity.add(this.backend)}disable(){this.entity&&this.backend&&this.entity.remove(this.backend)}updateProjectionMatrix(){if(window.getRenderer()&&this.backend&&this.backend.isCamera){window.getRenderer().getSize(bt);let e=bt.x,t=bt.y;if(this.backend.isPerspectiveCamera)this.data.fixedSize&&(this.backend.fov=360/Math.PI*Math.atan(this._tanFOV*(t/this._windowHeight))),this.backend.aspect=e/t;else if(this.backend.isOrthographicCamera){let i=1,s=1;this.backend.left=-e/i/2,this.backend.right=e/i/2,this.backend.top=t*s/2,this.backend.bottom=-t*s/2}this.backend.updateProjectionMatrix()}}toJSON(){const e=this.defaultData("style",this.style);for(let t in e)void 0!==this.data[t]&&(e[t]=this.data[t]);if(this.backend)for(let t in e){let i=this.backend[t];void 0!==i&&(e[t]=i)}return e}}wt.config={schema:{style:{type:"select",default:"perspective",select:["perspective","orthographic"]},nearPersp:{type:"number",default:1,if:{style:["perspective"]}},farPersp:{type:"number",default:1e5,if:{style:["perspective"]}},nearOrtho:{type:"number",default:-5e4,if:{style:["orthographic"]}},farOrtho:{type:"number",default:5e4,if:{style:["orthographic"]}},fov:{type:"number",default:58.1,if:{style:["perspective"]}},fixedSize:{type:"boolean",default:!0,if:{style:["perspective"]}},left:{type:"number",default:-1,if:{style:["orthographic"]}},right:{type:"number",default:1,if:{style:["orthographic"]}},top:{type:"number",default:1,if:{style:["orthographic"]}},bottom:{type:"number",default:-1,if:{style:["orthographic"]}}},icon:"",color:"#4B4886"},_.register("camera",wt);class xt{init(t){if(this.backend&&this.backend.isBufferGeometry&&(this.backend.dispose(),this.backend=void 0),t.isBufferGeometry){const e=t.uuid;G.addAsset(t),(t=this.defaultData("style","asset")).asset=e}let s;switch(t.style){case"asset":const r=G.getAsset(t.asset);r&&r.isBufferGeometry&&(s=r.clone());break;case"box":s=new e.BoxGeometry(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments);break;case"capsule":const n=M.clamp(t.radiusTop,.1,t.height)/1.5,a=M.clamp(t.radiusBottom,.1,t.height)/1.5,o=t.height/1.5;s=new He(n,a,o,t.radialSegments,t.heightSegments,t.capSegments,t.capSegments,t.thetaStart,t.thetaLength),s=pe.uvMapSphere(s,"v");break;case"circle":s=new e.CircleGeometry(t.radius,t.segments,t.thetaStart,t.thetaLength);break;case"cone":s=new qe(0,t.radius,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength);break;case"cylinder":s=new qe(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength);break;case"lathe":const l=(new i).parse('\n                    <g transform="matrix(1,0,0,1,-62,77.5)">\n                        <path d="M125,59C151.284,141.301 106.947,164.354 84,158L83,263C100.017,285.361 110.282,295.752 143,298" style="fill:none;stroke:black;stroke-width:1px;"/>\n                    </g>\n                '),c=l.paths[Object.keys(l.paths)[0]],d=i.createShapes(c)[0].extractPoints(30),u=[];for(let t=d.shape.length-1;t>=0;t--)u.push(new e.Vector2(.005*d.shape[t].x,-.005*d.shape[t].y));s=new e.LatheGeometry(u,t.segments,0,t.phiLength),s.center();break;case"plane":s=new e.PlaneGeometry(t.width,t.height,t.widthSegments,t.heightSegments);break;case"platonicSolid":switch(t.polyhedron){case"dodecahedron":default:s=new e.DodecahedronGeometry(t.radius,t.detail);break;case"icosahedron":s=new e.IcosahedronGeometry(t.radius,t.detail);break;case"octahedron":s=new e.OctahedronGeometry(t.radius,t.detail);break;case"tetrahedron":s=new e.TetrahedronGeometry(t.radius,t.detail)}break;case"ring":s=new e.RingGeometry(t.innerRadius,t.outerRadius,t.thetaSegments,t.phiSegments,t.thetaStart,t.thetaLength);break;case"roundedBox":s=new h(t.width,t.height,t.depth,t.segments,t.radius);break;case"shape":t.shapes??new e.Shape([new e.Vector2(64,8),new e.Vector2(0,64),new e.Vector2(-64,8),new e.Vector2(-32,-64),new e.Vector2(32,-64)]);const p=[];p.push(new e.Vector2(610,320)),p.push(new e.Vector2(450,300)),p.push(new e.Vector2(392,392)),p.push(new e.Vector2(266,438)),p.push(new e.Vector2(190,570)),p.push(new e.Vector2(190,600)),p.push(new e.Vector2(160,620)),p.push(new e.Vector2(160,650)),p.push(new e.Vector2(180,640)),p.push(new e.Vector2(165,680)),p.push(new e.Vector2(150,670)),p.push(new e.Vector2(90,737)),p.push(new e.Vector2(80,795)),p.push(new e.Vector2(50,835)),p.push(new e.Vector2(64,870)),p.push(new e.Vector2(60,945)),p.push(new e.Vector2(300,945)),p.push(new e.Vector2(300,743)),p.push(new e.Vector2(600,473)),p.push(new e.Vector2(626,425)),p.push(new e.Vector2(600,370)),p.push(new e.Vector2(610,320));for(let e=0;e<p.length;e++)p[e].multiplyScalar(.001);new e.Shape(p);const m=new e.Shape;m.absarc(0,0,.5);const y={depth:t.depth,curveSegments:t.curveSegments,steps:t.steps,bevelEnabled:t.bevelEnabled,bevelThickness:t.bevelThickness,bevelSize:t.bevelSize,bevelSegments:t.bevelSegments};s=new e.ExtrudeGeometry(m,y),s.center();break;case"sphere":s=new e.SphereGeometry(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength);break;case"torus":s=new e.TorusGeometry(t.radius,t.tube,t.radialSegments,t.tubularSegments,t.arc);break;case"torusKnot":s=new e.TorusKnotGeometry(t.radius,t.tube,t.tubularSegments,t.radialSegments,t.p,t.q);break;case"tube":const f=(new e.Shape).moveTo(25,25).bezierCurveTo(25,25,20,0,0,0).bezierCurveTo(-30,0,-30,35,-30,35).bezierCurveTo(-30,55,-10,77,25,95).bezierCurveTo(60,77,80,55,80,35).bezierCurveTo(80,35,80,0,50,0).bezierCurveTo(35,0,25,25,25,25).getPoints(256),g=[];for(let t=0;t<f.length;t+=2){const i=f[t],s=f[t+1]||i;g.push(new e.LineCurve3(new e.Vector3(.01*i.x,-.01*i.y,0),new e.Vector3(.01*s.x,-.01*s.y,0)))}const b=new e.CurvePath;b.curves.push(...g),s=new e.TubeGeometry(b,t.tubularSegments,t.radius,t.radialSegments,t.closed),s.center();break;default:console.error("Geometry: Invalid geometry type "+t.style)}if(s&&s.isBufferGeometry){const e=s.constructor.name,i={split:t.edgeSplit??!1,uvSmooth:t.uvSmooth??!1,flatOnly:t.flatOnly??!1,preserveEdges:!1,maxTriangles:25e3};if(i.split||t.subdivide>0){let e=d.modify(s,t.subdivide,i);e&&(s.dispose(),s=e)}if("cube"===t.textureMapping?s=pe.uvMapCube(s):"sphere"===t.textureMapping&&(s=pe.uvMapSphere(s)),1!==t.wrapS||1!==t.wrapT){const e=Math.max(t.wrapS,0),i=Math.max(t.wrapT,0);pe.repeatTexture(s,e,i)}s.name=e}this.backend=s,this.data=t,this.style=t.style}dispose(){this.backend&&this.backend.dispose&&this.backend.dispose()}enable(){if(!this.entity)return;const e=this.entity.getComponent("material");void 0!==e&&e.refreshMesh()}disable(){if(!this.entity)return;const e=this.entity.getComponent("material");void 0!==e&&e.refreshMesh()}toJSON(){const e=this.defaultData("style",this.style);for(let t in e)void 0!==this.data[t]&&(e[t]=this.data[t]);return e}}xt.config={schema:{style:[{type:"select",default:"box",select:["asset","box","capsule","circle","cone","cylinder","lathe","plane","platonicSolid","ring","roundedBox","shape","sphere","torus","torusKnot","tube"]}],asset:{type:"asset",if:{style:["asset"]}},styleDivider:{type:"divider"},polyhedron:[{type:"select",default:"dodecahedron",select:["dodecahedron","icosahedron","octahedron","tetrahedron"],if:{style:["platonicSolid"]}}],points:{type:"shape",alias:"points",default:null,if:{style:["lathe"]}},shapes:{type:"shape",alias:"shape",default:null,if:{style:["shape"]}},path:{type:"shape",alias:"curve",default:null,if:{style:["tube"]}},depth:[{type:"number",default:1,min:0,step:"grid",if:{style:["box","roundedBox"]}},{type:"number",default:.4,min:0,step:"grid",if:{style:["shape"]}}],height:[{type:"number",default:1,min:0,step:"grid",if:{style:["box","capsule","cone","cylinder","plane","roundedBox"]}}],width:[{type:"number",default:1,min:0,step:"grid",if:{style:["box","plane","roundedBox"]}}],widthSegments:[{type:"int",default:1,min:1,max:1024,promode:!0,if:{style:["box","plane"]}},{type:"int",default:24,min:4,max:1024,if:{style:["sphere"]}}],heightSegments:[{type:"int",default:1,min:1,max:1024,promode:!0,if:{style:["box","plane"]}},{type:"int",default:1,min:1,max:1024,if:{style:["cone","cylinder"]}},{type:"int",default:24,min:1,max:1024,if:{style:["sphere"]}}],depthSegments:[{type:"int",default:1,min:1,max:1024,promode:!0,if:{style:["box"]}}],radius:[{type:"number",default:.25,min:0,step:.01,if:{style:["roundedBox"]}},{type:"number",default:.5,min:0,step:.01,if:{style:["circle","cone","platonicSolid","sphere"]}},{type:"number",default:.5,min:0,step:.01,if:{style:["torus"]}},{type:"number",default:.4,min:0,step:.01,if:{style:["torusKnot"]}},{type:"number",default:.2,min:0,step:.01,if:{style:["tube"]}}],radiusTop:[{type:"number",default:.5,min:0,step:.01,if:{style:["capsule"]}},{type:"number",default:.5,min:0,step:.01,if:{style:["cylinder"]}}],radiusBottom:[{type:"number",default:.5,min:0,step:.01,if:{style:["capsule"]}},{type:"number",default:.5,min:0,step:.01,if:{style:["cylinder"]}}],segments:[{type:"int",default:36,min:3,max:64,if:{style:["circle"]}},{type:"int",default:16,min:1,max:64,if:{style:["lathe"]}},{type:"int",default:4,min:1,max:10,if:{style:["roundedBox"]}}],thetaLength:[{type:"angle",default:2*Math.PI,min:0,max:360,if:{style:["circle","ring"]}},{type:"angle",default:2*Math.PI,min:0,max:360,promode:!0,if:{style:["capsule","cone","cylinder"]}},{type:"angle",default:Math.PI,min:0,max:720,promode:!0,if:{style:["sphere"]}}],thetaStart:[{type:"angle",default:0,if:{style:["circle","ring","sphere"]}},{type:"angle",default:0,promode:!0,if:{style:["capsule","cone","cylinder"]}}],phiLength:{type:"angle",default:2*Math.PI,max:360,if:{style:["lathe","sphere"]}},phiStart:{type:"angle",default:0,if:{style:["sphere"]}},capSegments:{type:"int",default:6,min:1,max:36,if:{style:["capsule"]}},radialSegments:[{type:"int",default:24,min:2,max:64,if:{style:["capsule","cone","cylinder","torus","torusKnot","tube"]}}],openEnded:{type:"boolean",default:!1,if:{style:["cone","cylinder"]}},detail:{type:"slider",default:0,min:0,max:9,step:1,precision:0,if:{style:["platonicSolid"]}},innerRadius:{type:"number",default:.25,min:0,step:.01,if:{style:["ring"]}},outerRadius:{type:"number",default:.5,min:0,step:.01,if:{style:["ring"]}},phiSegments:{type:"int",default:10,min:1,max:64,promode:!0,if:{style:["ring"]}},thetaSegments:{type:"int",default:36,min:3,max:128,if:{style:["ring"]}},steps:{type:"int",alias:"Depth Segments",default:8,min:1,max:128,promode:!0,if:{style:["shape"]}},bevelEnabled:{type:"boolean",alias:"bevel",default:!0,if:{style:["shape"]}},bevelThickness:{type:"number",default:.1,min:0,step:.01,if:{style:["shape"],bevelEnabled:[!0]}},bevelSize:{type:"number",default:.1,min:0,step:.01,if:{style:["shape"],bevelEnabled:[!0]}},bevelSegments:{type:"int",default:4,min:0,max:64,promode:!0,if:{style:["shape"],bevelEnabled:[!0]}},curveSegments:{type:"int",default:16,min:1,max:128,promode:!0,if:{style:["shape"]}},tube:[{type:"number",default:.2,min:0,step:.01,if:{style:["torus"]}},{type:"number",default:.1,min:0,step:.01,if:{style:["torusKnot"]}}],tubularSegments:[{type:"int",default:32,min:3,max:128,if:{style:["torus"]}},{type:"int",default:64,min:3,max:128,if:{style:["torusKnot"]}},{type:"int",default:64,min:2,if:{style:["tube"]}}],arc:{type:"angle",default:2*Math.PI,min:0,max:360,if:{style:["torus"]}},p:{type:"number",default:2,min:1,max:128,if:{style:["torusKnot"]}},q:{type:"number",default:3,min:1,max:128,if:{style:["torusKnot"]}},closed:{type:"boolean",default:!0,if:{style:["tube"]}},modifierDivider:{type:"divider"},subdivide:{type:"slider",default:0,min:0,max:5,step:1,precision:0},edgeSplit:{type:"boolean",default:!1,hide:{subdivide:[0]}},uvSmooth:{type:"boolean",default:!1,promode:!0,hide:{subdivide:[0]}},flatOnly:{type:"boolean",default:!1,promode:!0,hide:{subdivide:[0]}},textureDivider:{type:"divider"},textureMapping:[{type:"select",default:"cube",select:["none","cube","sphere"],if:{style:["shape"]}},{type:"select",default:"none",select:["none","cube","sphere"],not:{style:["shape"]}}],wrapS:{type:"number",alias:"wrapX",default:1,min:0,step:.2,precision:2},wrapT:{type:"number",alias:"wrapY",default:1,min:0,step:.2,precision:2}},icon:"",color:"rgb(255, 113, 0)",dependencies:["material"]},_.register("geometry",xt);class vt{init(t){let i;switch(t.style){case"ambient":i=new e.AmbientLight(t.color,t.intensity);break;case"directional":i=new e.DirectionalLight(t.color,t.intensity),i.castShadow=!0,i.shadow.mapSize.width=2048,i.shadow.mapSize.height=2048;const s=5;i.shadow.camera.near=1,i.shadow.camera.far=500,i.shadow.camera.left=-s,i.shadow.camera.right=s,i.shadow.camera.top=s,i.shadow.camera.bottom=-s,i.shadow.camera.updateProjectionMatrix(),i.shadow.bias=t.shadowBias;break;case"hemisphere":i=new e.HemisphereLight(t.color,t.groundColor,t.intensity);break;case"point":i=new e.PointLight(t.color,t.intensity,t.distance,t.decay),i.castShadow=!0,i.shadow.bias=t.shadowBias;break;case"spot":i=new e.SpotLight(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay),i.castShadow=!0,i.shadow.bias=t.shadowBias;break;default:console.error(`Light: Invalid light type '${t.style}'`)}i&&i.isLight||console.log("Error with light!"),this.backend=i,this.data=t,this.style=t.style}dispose(){this.backend&&this.backend.isLight&&this.backend.dispose()}enable(){this.entity&&this.backend&&this.entity.add(this.backend)}disable(){this.entity&&this.backend&&this.entity.remove(this.backend)}toJSON(){const e=this.defaultData("style",this.style);for(let t in e)void 0!==this.data[t]&&(e[t]=this.data[t]);if(this.backend){for(let t in e){let i=this.backend[t];void 0!==i&&(i&&i.isColor?e[t]=i.getHex():e[t]=i)}this.backend.shadow&&(e.shadowBias=this.backend.shadow.bias)}return e}}vt.config={schema:{style:{type:"select",default:"ambient",select:["ambient","directional","hemisphere","point","spot"]},styleDivider:{type:"divider"},color:[{type:"color",default:16777215,if:{style:["ambient","directional","point","spot"]}},{type:"color",alias:"skyColor",default:8454143,if:{style:["hemisphere"]}}],groundColor:{type:"color",default:8413248,if:{style:["hemisphere"]}},intensity:[{type:"slider",default:.25,step:.1,min:0,max:2,if:{style:["ambient"]}},{type:"slider",default:.5,step:.1,min:0,max:2,if:{style:["hemisphere"]}},{type:"slider",default:1,step:.1,min:0,max:2,if:{style:["directional"]}},{type:"slider",default:1,step:.1,min:0,max:2,if:{style:["point","spot"]}}],distance:{type:"number",default:0,if:{style:["point","spot"]}},decay:{type:"number",default:1,if:{style:["point","spot"]}},angle:{type:"number",default:Math.PI/3,unit:"°",if:{style:["spot"]}},penumbra:{type:"number",default:0,if:{style:["spot"]}},shadowBias:{type:"number",default:0,precision:6,promode:!0,if:{style:["directional","point","spot"]}}},icon:"",color:"#222222"},_.register("light",vt);const St=["NoBlending","NormalBlending","AdditiveBlending","SubstractiveBlending","MultiplyBlending","CustomBlending"],kt=["FrontSide","BackSide","DoubleSide"];class Mt{init(t){this.backend&&this.backend.isMaterial&&(this.backend.dispose(),this.backend=void 0);const i={};if(t.isMaterial){const e=t.uuid;G.addAsset(t),(t=this.defaultData("style","asset")).asset=e}else{for(const e in t){const s=t[e];i[e]=s;let r=Mt.config.schema[e];if(z.isIterable(r)&&r.length>0&&(r=r[0]),s&&r&&"map"===r.type)if(s.isTexture)G.addAsset(s);else{const t=G.getAsset(s);t&&t.isTexture?i[e]=t:i[e]=null}}delete i.base,delete i.style,delete i.edgeSize,delete i.gradientSize,delete i.premultiplyAlpha,"string"==typeof i.blending&&(i.blending=St.indexOf(i.blending)),"string"==typeof i.side&&(i.side=kt.indexOf(i.side)),"BasicDepthPacking"===i.depthPacking&&(i.depthPacking=e.BasicDepthPacking),"RGBADepthPacking"===i.depthPacking&&(i.depthPacking=e.RGBADepthPacking)}let s;switch(t.style){case"asset":const r=G.getAsset(t.asset);r&&r.isMaterial&&(s=r.clone());break;case"basic":s=new e.MeshBasicMaterial(i);break;case"depth":s=new e.MeshDepthMaterial(i);break;case"lambert":s=new e.MeshLambertMaterial(i);break;case"matcap":s=new e.MeshMatcapMaterial(i);break;case"normal":s=new e.MeshNormalMaterial(i);break;case"phong":s=new e.MeshPhongMaterial(i);break;case"physical":s=new e.MeshPhysicalMaterial(i);break;case"points":s=new e.PointsMaterial(i);break;case"shader":s=new e.ShaderMaterial(i);break;case"standard":s=new e.MeshStandardMaterial(i);break;case"toon":s=new e.MeshToonMaterial(i),t.gradientSize=Math.min(Math.max(t.gradientSize,1),16);const n=getRenderer().capabilities.isWebGL2?e.RedFormat:e.LuminanceFormat,a=new Uint8Array(t.gradientSize+2);for(let e=0;e<=a.length;e++)a[e]=e/a.length*256;s.gradientMap=new e.DataTexture(a,a.length,1,n),s.gradientMap.needsUpdate=!0;break;default:console.error(`Material: Invalid material type '${t.style}'`)}s&&s.isMaterial||console.log("Error with material!"),this.backend=s,this.data=t,this.style=t.style}dispose(){this.backend&&this.backend.dispose&&this.backend.dispose()}enable(){this.refreshMesh()}disable(){this.refreshMesh()}refreshMesh(){if(this.entity&&this.mesh&&this.entity.remove(this.mesh),!0!==this.enabled)return;if(!this.backend||!this.backend.isMaterial)return;const t=this.backend.clone();!function(t,i={style:"basic",premultiplyAlpha:!0}){if(!t||!t.isMaterial)return;let s=i&&1===i.opacity&&void 0===i.map;t.transparent=!s,t.alphaTest=.01,t.polygonOffset=!0,t.polygonOffsetFactor=1,t.onBeforeCompile=function(s){"toon"===i.style&&(s.uniforms=e.UniformsUtils.merge([s.uniforms,{uBitDepth:{value:i.gradientSize??4},uEdgeSize:{value:i.edgeSize??6},uTextureWidth:{value:100},uTextureHeight:{value:100}}]),t.map&&t.map.isTexture&&(s.uniforms.uTextureWidth.value=t.map.image.width,s.uniforms.uTextureHeight.value=t.map.image.height),s.fragmentShader=s.fragmentShader.replace("#include <common>",["#include <common>","","uniform float uBitDepth;","uniform float uEdgeSize;","uniform float uTextureWidth;","uniform float uTextureHeight;","","vec3 rgbToHsv(vec3 c) {","   vec4  K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","   vec4  p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","   vec4  q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","   float d = q.x - min(q.w, q.y);","   float e = 1.0e-10;","   return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsvToRgb(vec3 c) {","   vec4  K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","   vec3  p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","   return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","","float avgIntensity(vec4 pix) {","   return (pix.r + pix.g + pix.b) / 3.0;","}"].join("\n")),s.fragmentShader=s.fragmentShader.replace("#include <color_fragment>",["#include <color_fragment>","vec3 original_color = diffuseColor.rgb;","vec3 v_hsv = rgbToHsv(original_color.rgb);","float amt = 1.0 / (uBitDepth + 8.0);","float hueIncrease = 1.05;","float satIncrease = 1.10;","float vibIncrease = 1.75;","v_hsv.x = clamp(amt * (floor(v_hsv.x / amt) * hueIncrease), 0.0, 1.0);","v_hsv.y = clamp(amt * (floor(v_hsv.y / amt) * satIncrease), 0.0, 1.0);","v_hsv.z = clamp(amt * (floor(v_hsv.z / amt) * vibIncrease), 0.0, 1.0);","#ifdef USE_MAP","   vec2 coords = vUv;","   float dxtex = 1.0 / uTextureWidth;","   float dytex = 1.0 / uTextureHeight;","   float edge_thres  = 0.15;","   float edge_thres2 = uEdgeSize;","   float pix[9];","   int   k = -1;","   float delta;","   for (int i = -1; i < 2; i++) {","       for (int j = -1; j < 2; j++) {","           k++;","           vec2 sampleCoords = vec2(coords.x + (float(i) * dxtex), coords.y + (float(j) * dytex));","           vec4 texSample = texture2D(map, sampleCoords);","           pix[k] = avgIntensity(texSample);","       }","   }","   delta = (abs(pix[1] - pix[7]) + abs(pix[5] - pix[3]) + abs(pix[0] - pix[8]) + abs(pix[2] - pix[6]) ) / 4.0;","   float edg = clamp(edge_thres2 * delta, 0.0, 1.0);","   vec3 v_rgb = (edg >= edge_thres) ? vec3(0.0) : hsvToRgb(v_hsv.xyz);","#else","   vec3 v_rgb = hsvToRgb(v_hsv.xyz);","#endif","diffuseColor.rgb = vec3(v_rgb.x, v_rgb.y, v_rgb.z);","float bit_depth = uBitDepth;","float bitR = floor(diffuseColor.r * bit_depth);","float bitG = floor(diffuseColor.g * bit_depth);","float bitB = floor(diffuseColor.b * bit_depth);","diffuseColor.rgb = vec3(bitR, bitG, bitB) / bit_depth;"].join("\n"))),i.premultiplyAlpha&&s.fragmentShader&&(s.fragmentShader=s.fragmentShader.replace("#include <premultiplied_alpha_fragment>","gl_FragColor.rgba *= gl_FragColor.a;"))},i.premultiplyAlpha&&(t.blending=e.CustomBlending,t.blendEquation=e.AddEquation,t.blendSrc=e.OneFactor,t.blendDst=e.OneMinusSrcAlphaFactor,t.blendEquationAlpha=e.AddEquation,t.blendSrcAlpha=e.OneFactor,t.blendDstAlpha=e.OneMinusSrcAlphaFactor);t.needsUpdate=!0}(t,this.toJSON());const i=this.entity.getComponent("geometry");if(!i)return;if(!i.enabled)return;const s=i.backend;if(!s)return;"points"===this.style?this.mesh=new e.Points(s,t):(this.mesh=new e.Mesh(s,t),this.mesh.castShadow=this.entity.castShadow,this.mesh.receiveShadow=this.entity.receiveShadow),this.mesh.name=`Backend Object3D for ${this.entity.name}`;!0===this.backend.isMeshPhysicalMaterial&&this.backend.transmission>0&&(this.backend.envMap=hdrEquirect),this.backend.opacity<.05&&window.activeCamera&&window.editor&&window.editor.viewport&&activeCamera.uuid===editor.viewport.camera.uuid&&(t.map=null,t.opacity=.25,t.wireframe=!0,this.mesh.castShadow=!1),this.entity&&this.mesh&&this.entity.add(this.mesh)}toJSON(){const e=this.defaultData("style",this.style);for(let t in e)void 0!==this.data[t]&&(this.data[t]&&this.data[t].isTexture?e[t]=this.data[t].uuid:e[t]=this.data[t]);return e}}Mt.config={schema:{style:[{type:"select",default:"standard",promode:!0,select:["asset","basic","depth","lambert","matcap","normal","phong","physical","points","shader","standard","toon"]},{type:"select",default:"standard",select:["basic","points","standard","toon"]}],styleDivider:{type:"divider"},asset:{type:"asset",if:{style:["asset"]}},color:{type:"color",if:{style:["basic","lambert","matcap","phong","physical","points","standard","toon"]}},emissive:{type:"color",default:0,if:{style:["lambert","phong","physical","standard","toon"]}},emissiveIntensity:{type:"slider",default:1,min:0,max:2,promode:!0,if:{style:["lambert","phong","physical","standard","toon"]}},opacity:{type:"slider",default:1,min:0,max:1,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","points","standard","toon"]}},depthTest:{type:"boolean",default:!0,promode:!0,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","standard","toon"]}},depthWrite:{type:"boolean",default:!0,promode:!0,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","standard","toon"]}},flatShading:{type:"boolean",default:!1,if:{style:["phong","physical","standard","normal","matcap"]}},premultiplyAlpha:{type:"boolean",default:!0,promode:!0,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","points","standard","toon"]}},wireframe:{type:"boolean",default:!1,if:{style:["basic","depth","lambert","normal","phong","physical","standard","toon"]}},vertexColors:{type:"boolean",default:!1,promode:!0,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","standard","toon"]}},size:{type:"slider",default:.05,min:0,max:1,if:{style:["points"]}},sizeAttenuation:{type:"boolean",default:!0,if:{style:["points"]}},edgeSize:{type:"slider",default:6,min:0,max:10,step:1,precision:0,if:{style:["toon"]}},gradientSize:{type:"slider",default:4,min:1,max:16,step:1,precision:0,if:{style:["toon"]}},metalness:{type:"slider",default:.1,min:0,max:1,if:{style:["physical","standard"]}},roughness:{type:"slider",default:1,min:0,max:1,if:{style:["physical","standard"]}},specular:{type:"color",default:1118481,if:{style:["phong"]}},shininess:{type:"number",default:30,if:{style:["phong"]}},clearcoat:{type:"slider",default:0,min:0,max:1,if:{style:["physical"]}},clearcoatRoughness:{type:"slider",default:0,min:0,max:1,if:{style:["physical"]}},ior:{type:"slider",default:1.5,min:1,max:2,if:{style:["physical"]}},sheen:{type:"slider",default:0,min:0,max:1,if:{style:["physical"]}},sheenRoughness:{type:"slider",default:0,min:0,max:1,if:{style:["physical"]}},sheenColor:{type:"color",if:{style:["physical"]}},specularColor:{type:"color",promode:!0,if:{style:["physical"]}},specularIntensity:{type:"slider",default:1,min:0,max:2,promode:!0,if:{style:["physical"]}},thickness:{type:"slider",default:0,min:0,max:5,if:{style:["physical"]}},transmission:{type:"slider",default:0,min:0,max:1,if:{style:["physical"]}},depthPacking:{type:"select",default:"BasicDepthPacking",select:["BasicDepthPacking","RGBADepthPacking"],if:{style:["depth"]}},map:[{type:"map",if:{style:["basic","depth","lambert","matcap","phong","points","physical","standard","toon"]}}],matcap:{type:"map",if:{style:["matcap"]}},alphaMap:{type:"map",promode:!0,if:{style:["basic","depth","lambert","matcap","phong","physical","points","standard","toon"]}},bumpMap:{type:"map",promode:!0,if:{style:["matcap","normal","phong","physical","standard","toon"]}},bumpScale:{type:"slider",default:1,min:0,max:2,promode:!0,if:{style:["matcap","normal","phong","physical","standard","toon"]}},clearcoatNormalMap:{type:"map",promode:!0,if:{style:["physical"]}},clearcoatNormalScale:{type:"vector2",default:[1,1],promode:!0,if:{style:["physical"]}},displacementMap:{type:"map",promode:!0,if:{style:["depth","matcap","normal","phong","physical","standard","toon"]}},displacementScale:{type:"slider",default:1,min:0,max:2,promode:!0,if:{style:["depth","matcap","normal","phong","physical","standard","toon"]}},emissiveMap:{type:"map",promode:!0,if:{style:["lambert","phong","physical","standard","toon"]}},metalnessMap:{type:"map",promode:!0,if:{style:["physical","standard"]}},roughnessMap:{type:"map",promode:!0,if:{style:["physical","standard"]}},specularMap:{type:"map",promode:!0,if:{style:["basic","lambert","phong"]}},thicknessMap:{type:"map",promode:!0,if:{style:["physical"]}},transmissionMap:{type:"map",promode:!0,if:{style:["physical"]}},aoMap:{type:"map",promode:!0,if:{style:["basic","lambert","phong","physical","standard","toon"]}},envMap:{type:"map",promode:!0,if:{style:["basic","lambert","phong","physical","standard"]}},lightMap:{type:"map",promode:!0,if:{style:["basic","lambert","phong","physical","standard","toon"]}},normalMap:{type:"map",if:{style:["matcap","normal","phong","physical","standard","toon"]}},side:{type:"select",default:"FrontSide",select:kt,if:{style:["basic","depth","lambert","matcap","normal","phong","physical","standard","toon"]}}},icon:"",color:"rgb(165, 243, 0)",dependencies:["geometry"]},_.register("material",Mt);class zt{init(t){this.backend=t.isObject3D?t:new e.Object3D,this.backend.traverse((e=>{e.castShadow=this.entity.castShadow})),this.backend.traverse((e=>{e.receiveShadow=this.entity.receiveShadow}))}dispose(){}enable(){this.entity&&this.backend&&this.entity.add(this.backend)}disable(){this.entity&&this.backend&&this.entity.remove(this.backend)}toJSON(){}}zt.config={multiple:!0,icon:"",color:"#F7DB63"},_.register("mesh",zt),"undefined"!=typeof window&&(window.__ONSIGHT__?console.warn("Multiple instances of Onsight being imported"):window.__ONSIGHT__="0.0.3");export{b as APP_STATES,oe as App,G as AssetManager,p as BACKENDS,it as BasicLine,rt as BasicWireBox,at as BasicWireframe,w as CAMERA_SCALE,x as CAMERA_START_DISTANCE,v as CAMERA_START_HEIGHT,k as CameraUtils,He as CapsuleGeometry,_ as ComponentManager,qe as CylinderGeometry,g as ENTITY_FLAGS,m as ENTITY_TYPES,ie as Entity3D,le as EntityPool,ne as EntityUtils,st as FatLine,nt as FatWireBox,ot as FatWireframe,pe as GeometryUtils,ft as GpuPickerPass,lt as HelperObject,ge as Iris,M as Maths,te as Object3D,D as ObjectUtils,Je as PrismGeometry,ae as Project,gt as RenderUtils,y as SCENE_TYPES,fe as SVGBuilder,se as Scene3D,ct as SkyObject,R as Strings,z as System,u as VERSION,ce as Vectors,f as WORLD_TYPES,re as World3D};
